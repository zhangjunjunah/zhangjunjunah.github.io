{"meta":{"title":"æœºé”‹å°æ‘©æ‰˜çš„åˆ†äº«","subtitle":"","description":"ä¸ªäººå­¦ä¹ åŠå·¥ä½œç»éªŒåˆ†äº«","author":"æœºé”‹å°æ‘©æ‰˜","url":"https://zhangjunjunah.github.io","root":"/"},"pages":[{"title":"å…³äº","date":"2020-03-22T01:24:33.077Z","updated":"2020-03-21T10:26:01.350Z","comments":false,"path":"about/index.html","permalink":"https://zhangjunjunah.github.io/about/index.html","excerpt":"","text":"ä¸ªäººè¯¦ç»†ä»‹ç»"},{"title":"ä¹¦å•","date":"2020-03-22T02:26:39.002Z","updated":"2020-03-22T02:26:39.002Z","comments":false,"path":"books/index.html","permalink":"https://zhangjunjunah.github.io/books/index.html","excerpt":"","text":"Effective Java Java ç¼–ç¨‹æ€æƒ³"},{"title":"åˆ†ç±»","date":"2020-03-21T10:26:01.351Z","updated":"2020-03-21T10:26:01.351Z","comments":false,"path":"categories/index.html","permalink":"https://zhangjunjunah.github.io/categories/index.html","excerpt":"","text":""},{"title":"æ ‡ç­¾","date":"2020-03-22T02:29:57.368Z","updated":"2020-03-22T02:29:57.368Z","comments":false,"path":"tags/index.html","permalink":"https://zhangjunjunah.github.io/tags/index.html","excerpt":"","text":"ceph"}],"posts":[{"title":"zeppelin 0.8.0 é€‚é…FusionInsight_HD_6.5.1.7","slug":"zeppelin-0-8-0-é€‚é…FusionInsight-HD-6-5-1-7","date":"2020-12-03T16:00:00.000Z","updated":"2020-12-04T09:38:52.847Z","comments":true,"path":"2020/12/04/zeppelin-0-8-0-é€‚é…FusionInsight-HD-6-5-1-7/","link":"","permalink":"https://zhangjunjunah.github.io/2020/12/04/zeppelin-0-8-0-%E9%80%82%E9%85%8DFusionInsight-HD-6-5-1-7/","excerpt":"","text":"é€‚é…èƒŒæ™¯â€‹ æœ€è¿‘å®¢æˆ·çš„åä¸ºé›†ç¾¤å‡çº§åˆ°6.5.1.7ï¼Œæˆ‘ä»¬å®‰è£…çš„zeppelinåˆä¸å¥½ä½¿äº†ã€‚ã€‚ã€‚ é€‚é…æ–¹æ³•â€‹ é€‚é…æ–¹æ³•å‚è€ƒä¸€ç¯‡blogï¼Œåœ¨è¿™é‡Œåˆ—å‡ºä¸»è¦æ­¥éª¤ â€‹ 1.å°†/opt/hadoopclient/Spark2x/spark/jarsè·¯å¾„ä¸‹æ‰€æœ‰çš„jaråŒ…æ‹·è´è‡³/usr/zeppelin/interpreter/spark 1cp &#x2F;opt&#x2F;hadoopclient&#x2F;Spark2x&#x2F;spark&#x2F;jars&#x2F;*.jar &#x2F;usr&#x2F;zeppelin&#x2F;interpreter&#x2F;spark&#x2F; â€‹ 2.ç¼–è¾‘zeppelin-env.shæ–‡ä»¶ï¼Œä½ç½®/usr/zeppelin/confï¼ŒåŠ å…¥ä»¥ä¸‹å†…å®¹ 1234export JAVA_HOME&#x3D;&#x2F;opt&#x2F;hadoopclient&#x2F;JDK&#x2F;jdk-8u201export MASTER&#x3D;yarn-clientexport SPARK_HOME&#x3D;&#x2F;opt&#x2F;hadoopclient&#x2F;Spark2x&#x2F;sparkexport HADOOP_CONF_DIR&#x3D;&#x2F;opt&#x2F;hadoopclient&#x2F;HDFS&#x2F;hadoop&#x2F;etc&#x2F;hadoop æ­¥éª¤æ¯”è¾ƒç®€å•ï¼Œæµ‹è¯•æäº¤åˆ°yarné›†ç¾¤ï¼Œå´æç¤º(è¿™ä¸ªé—®é¢˜å›°æ‰°äº†æˆ‘å‡ å¤©ã€‚ã€‚ã€‚) 1234567891011java.lang.ClassCastException: org.apache.hadoop.conf.Configuration cannot be cast to org.apache.hadoop.yarn.conf.YarnConfiguration at org.apache.spark.deploy.yarn.ApplicationMaster.&lt;init&gt;(ApplicationMaster.scala:60) at org.apache.spark.deploy.yarn.ApplicationMaster$$anonfun$main$1.apply$mcV$sp(ApplicationMaster.scala:679) at org.apache.spark.deploy.SparkHadoopUtil$$anon$1.run(SparkHadoopUtil.scala:69) at org.apache.spark.deploy.SparkHadoopUtil$$anon$1.run(SparkHadoopUtil.scala:68) at java.security.AccessController.doPrivileged(Native Method) at javax.security.auth.Subject.doAs(Subject.java:422) at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1917) at org.apache.spark.deploy.SparkHadoopUtil.runAsSparkUser(SparkHadoopUtil.scala:68) at org.apache.spark.deploy.yarn.ApplicationMaster$.main(ApplicationMaster.scala:678) at org.apache.spark.deploy.yarn.ApplicationMaster.main(ApplicationMaster.scala) ä¸‹é¢ç»™å‡ºæˆ‘è¿™è¾¹è§£å†³æ–¹æ³• é€‚é…é—®é¢˜è§£å†³ç½‘ä¸Šæç¤ºè¿™ä¸ªæŠ¥é”™çš„è§£å†³æ–¹æ³• ç”±äºç¯å¢ƒä¸­ç‰ˆæœ¬ä¸ä¸€è‡´å¯¼è‡´ï¼Œéœ€è¦ç¡®ä¿ç¯å¢ƒä¸­sparkç‰ˆæœ¬å’Œhadoopç‰ˆæœ¬ä¸ºåŒ¹é…ç‰ˆæœ¬ï¼š 1.ç¡®è®¤sparkç‰ˆæœ¬ä¸hadoopç‰ˆæœ¬ä¸€è‡´ã€‚ 2.å¦‚æœæ˜¯spark on yarnï¼ŒåŒæ—¶ç¡®è®¤sparké…ç½®æ–‡ä»¶ä¸­çš„spark.yarn.archiveæˆ–spark.yarn.jarçš„sparkç‰ˆæœ¬ã€‚ â€‹ æˆ‘æ£€æŸ¥äº†ä¸‹ï¼Œzeppelin ${zeppelin_home}/interpreter/spark/ å’Œ ${zeppelin_home}/libä¸‹çš„hadoopç‰ˆæœ¬ï¼Œå‘ç°${zeppelin_home}/libä¸‹çš„hadoopè¿˜æ˜¯2.Ã—çš„ç‰ˆæœ¬(FusionInsight_HD_6.5.1.7 hadoop 3.1.1)ã€‚äºæ˜¯æ»¡æ€€æœŸå¾…çš„æ›¿æ¢äº†ï¼Œæµ‹è¯•[è£‚å¼€äº†]è¿˜æ˜¯ä¸å¥½ä½¿ï¼Œä¾ç„¶æŠ¥åŒæ ·çš„é”™ã€‚ â€‹ æ‰¾ä¸åˆ°é—®é¢˜åªå¥½å¢åŠ ç‚¹æ—¥å¿—ï¼Œçœ‹çœ‹åº”ç”¨è¯»å–çš„spark_defaults.confï¼Œå‘ç°äº†ä¸ªå¥‡æ€ªçš„ç°è±¡ï¼Œspark.yarn.archiveå‚æ•°æœ‰é‡å¤ã€‚ 12spark.yarn.archive value:hdfs://hacluster/user/spark2x/jars/V100R002C80SPC200/spark-archive-2x.zipspark.yarn.archive:hdfs://hacluster/user/spark2x/jars/6.5.1.7/spark-archive-2x.zip ä½†æŸ¥çœ‹spark_defaults.confä¹Ÿåªå‘ç°ä¸‹é¢çš„é‚£ä¸€é¡¹ï¼ŒV100R002C80SPC200é‚£ä¸ªæ²¡æ‰¾æ‰“åœ¨å“ªé…ç½®ã€‚ã€‚ã€‚æ²¡åŠæ³•ï¼Œä¿®æ”¹ä¸‹zeppelinçš„æºç æ‰‹åŠ¨å‰”é™¤è¿™ä¸ªé…ç½®é¡¹ï¼Œé‡å¯é—®é¢˜è§£å†³ğŸ˜Šã€‚ é—®é¢˜åŸå› ï¼šå°±æ˜¯spark.yarn.archiveé…ç½®äº†ä¸æ˜ç‰ˆæœ¬çš„spark-archive-2x.zip å‚è€ƒæ–‡æ¡£Zeppelinè¿æ¥Spark","categories":[],"tags":[{"name":"spark","slug":"spark","permalink":"https://zhangjunjunah.github.io/tags/spark/"}]},{"title":"åœ¨å®¹å™¨ä¸­æäº¤yarn-clientè¿œç«¯sparkä»»åŠ¡","slug":"åœ¨å®¹å™¨ä¸­æäº¤yarn-clientè¿œç«¯sparkä»»åŠ¡","date":"2020-11-09T01:44:17.000Z","updated":"2020-11-10T01:54:27.795Z","comments":true,"path":"2020/11/09/åœ¨å®¹å™¨ä¸­æäº¤yarn-clientè¿œç«¯sparkä»»åŠ¡/","link":"","permalink":"https://zhangjunjunah.github.io/2020/11/09/%E5%9C%A8%E5%AE%B9%E5%99%A8%E4%B8%AD%E6%8F%90%E4%BA%A4yarn-client%E8%BF%9C%E7%AB%AFspark%E4%BB%BB%E5%8A%A1/","excerpt":"","text":"sparkåœ¨å®¹å™¨ä¸­æäº¤yarn-clientä»»åŠ¡æ–¹æ¡ˆä¸€ï¼šå®¹å™¨ç«¯å£nodePortæ˜ å°„æ–¹å¼æ–¹æ¡ˆè¯´æ˜â€‹ é»˜è®¤æƒ…å†µä¸‹ï¼Œ spark-submit ä½¿ç”¨podçš„ hostname ä½œä¸º spark.driver.host ï¼Œè€Œ hostname æ˜¯podçš„ä¸»æœºåï¼Œå› æ­¤ spark executor æ— æ³•è§£æå®ƒï¼Œè€Œä¸” spark.driver.port ä¹Ÿåœ¨podï¼ˆå®¹å™¨ï¼‰çš„æœ¬åœ°ã€‚æ­¤æ–¹æ¡ˆæ˜¯é€šè¿‡ç«¯å£æ˜ å°„æ–¹å¼è¿æ¥yarné›†ç¾¤ã€‚ åˆ›å»ºdeployementå’Œserviceçš„åŒæ—¶ï¼Œé€šè¿‡nodePortæ–¹å¼æš´éœ²spark.driver.portå’Œspark.blockManager.portä¸¤ä¸ªç«¯å£ spark-submitæäº¤å‘½ä»¤ï¼Œæ·»åŠ å‚æ•° â€“conf spark.driver.bindAddress=0.0.0.0 #å›ºå®šå€¼ â€“conf spark.driver.host=$HOST_IP #k8sèŠ‚ç‚¹ip,å¯ä»¥å›ºå®šä¸ºk8s masterèŠ‚ç‚¹ipï¼ˆéå®¿ä¸»èŠ‚ç‚¹ï¼‰ â€“conf spark.driver.port=$SPARK_DRIVER_PORT #é€šè¿‡nodePortæš´éœ²çš„ç«¯å£ â€“conf spark.driver.blockManager.port=$SPARK_DRIVER_PORT#é€šè¿‡nodePortæš´éœ²çš„ç«¯å£ æ–¹æ¡ˆäºŒï¼šhostNetworkæ¨¡å¼æ–¹æ¡ˆè¯´æ˜â€‹ å°†podä¿®æ”¹ä¸ºhostNetworkæ¨¡å¼ï¼Œå®¹å™¨å¯ä»¥ä½¿ç”¨å®¿ä¸»æœºçš„ç½‘ç»œåè®®æ ˆï¼Œå¤ç”¨å®¿ä¸»æœºçš„IPï¼Œå¯ä»¥ç›‘å¬ç«¯å£ï¼ŒSparkä¹Ÿå¯ä»¥å›è°ƒã€‚ æ–¹æ¡ˆä¸‰ï¼šè·¯ç”±è½¬å‘æ–¹æ¡ˆè¯´æ˜â€‹ ä¹‹æ‰€ä»¥åœ¨å®¹å™¨å†…æ— æ³•æäº¤spark yarn-clientä»»åŠ¡ï¼Œæ˜¯å› ä¸ºå®¹å™¨å†…ç½‘ä¸hadoopé›†ç¾¤ä¸äº’é€šï¼Œåªè¦æƒ³åŠæ³•è§£å†³ç½‘ç»œäº’é€šï¼Œé—®é¢˜è‡ªç„¶è€Œç„¶å°±è§£å†³äº†ã€‚ä¸‹é¢æ˜¯æˆ‘ä»¬æµ‹è¯•ç¯å¢ƒçš„ç½‘ç»œè½¬å‘å›¾ã€‚ å‚è€ƒblogåœ¨Kubernetesçš„podä¸­ä½¿ç”¨yarn-clientè°ƒç”¨è¿œç«¯sparké›†ç¾¤Spark/k8sï¼šå¦‚ä½•ç”¨å®¢æˆ·æœºæ¨¡å¼åœ¨Kubernetesä¸Šè¿è¡ŒSparkæäº¤k8séªšæ“ä½œ PodæœåŠ¡é€šè¿‡IPå¯¹å¤–è®¿é—®&amp;k8sæŒ‡å®šIPåˆ›å»ºPod","categories":[],"tags":[{"name":"K8S","slug":"K8S","permalink":"https://zhangjunjunah.github.io/tags/K8S/"}]},{"title":"ä¸€æ¬¡k8s 6443 ç«¯å£ was refused è§£å†³æ­¥éª¤åŠæ€è·¯","slug":"ä¸€æ¬¡k8s-6443-ç«¯å£-was-refused-è§£å†³æ­¥éª¤åŠæ€è·¯","date":"2020-10-25T01:19:07.000Z","updated":"2020-10-25T05:00:08.554Z","comments":true,"path":"2020/10/25/ä¸€æ¬¡k8s-6443-ç«¯å£-was-refused-è§£å†³æ­¥éª¤åŠæ€è·¯/","link":"","permalink":"https://zhangjunjunah.github.io/2020/10/25/%E4%B8%80%E6%AC%A1k8s-6443-%E7%AB%AF%E5%8F%A3-was-refused-%E8%A7%A3%E5%86%B3%E6%AD%A5%E9%AA%A4%E5%8F%8A%E6%80%9D%E8%B7%AF/","excerpt":"","text":"ä¸€ã€é—®é¢˜ç°è±¡â€‹ å‘¨ä¸€ä¸ŠåˆåŒäº‹å‘æˆ‘åé¦ˆè¯´å’±ä»¬çš„æµ‹è¯•k8sé›†ç¾¤kubectl å‘½ä»¤è¿æ¥ä¸ä¸Šæç¤ºThe connection to the server ip:6443 was refused - did you specify the right host or port?ï¼Œä¹‹å‰ä¹Ÿé‡åˆ°è¿‡è¿™ä¸ªé—®é¢˜ã€‚å½“æ—¶åˆšåˆšå¼€å§‹ä½¿ç”¨k8sï¼Œä¸Šé¢è¿˜æ²¡æœ‰pvï¼Œä¸ºäº†é¿å…è€½è¯¯å¼€å‘å¸è½½é‡è£…äº†(å¿ƒæƒ³è¿™æ¬¡æ€ä¹ˆä¹Ÿå¾—å…ˆåˆ†æä¸‹é—®é¢˜ï¼Œæœ‰ç‚¹è¿›æ­¥æ‰è¡Œ)ï¼Œäºæ˜¯æ…¢æ…¢å°è¯•ï¼Œä¸‹é¢è®°å½•äº†æˆ‘è§£å†³çš„å…¨è¿‡ç¨‹ã€‚ äºŒã€è§£å†³è¿‡ç¨‹â€‹ æŸ¥è¯¢äº†èµ„æ–™ 1.æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€1234567891011121314151617181920212223 systemctl status kubelet -lâ— kubelet.service - kubelet: The Kubernetes Node Agent Loaded: loaded (/usr/lib/systemd/system/kubelet.service; enabled; vendor preset: disabled) Drop-In: /usr/lib/systemd/system/kubelet.service.d â””â”€10-kubeadm.conf Active: active (running) since Mon 2020-10-12 14:16:53 CST; 26min ago Docs: https://kubernetes.io/docs/ Main PID: 2301 (kubelet) Tasks: 27 Memory: 134.8M CGroup: /system.slice/kubelet.service â””â”€2301 /usr/bin/kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf --config=/var/lib/kubelet/config.yaml --cgroup-driver=cgroupfs --network-plugin=cni --pod-infra-container-image=k8s.gcr.io/pause:3.1Oct 12 14:43:14 deeplearn kubelet[2301]: E1012 14:43:14.218811 2301 kubelet.go:2248] node \"deeplearn\" not foundOct 12 14:43:14 deeplearn kubelet[2301]: E1012 14:43:14.318986 2301 kubelet.go:2248] node \"deeplearn\" not foundOct 12 14:43:14 deeplearn kubelet[2301]: E1012 14:43:14.392439 2301 reflector.go:125] k8s.io/kubernetes/pkg/kubelet/config/apiserver.go:47: Failed to list *v1.Pod: Get https://ip:6443/api/v1/pods?fieldSelector=spec.nodeName%3Ddeeplearn&amp;limit=500&amp;resourceVersion=0: dial tcp ip:6443: connect: connection refusedOct 12 14:43:14 deeplearn kubelet[2301]: E1012 14:43:14.419206 2301 kubelet.go:2248] node \"deeplearn\" not foundOct 12 14:43:14 deeplearn kubelet[2301]: E1012 14:43:14.478573 2301 handler.go:321] HTTP InternalServerError serving /stats/summary: Internal Error: failed to get node info: node \"deeplearn\" not foundOct 12 14:43:14 deeplearn kubelet[2301]: E1012 14:43:14.478791 2301 handler.go:321] HTTP InternalServerError serving /stats/summary: Internal Error: failed to get node info: node \"deeplearn\" not foundOct 12 14:43:14 deeplearn kubelet[2301]: E1012 14:43:14.481661 2301 handler.go:321] HTTP InternalServerError serving /stats/summary: Internal Error: failed to get node info: node \"deeplearn\" not foundOct 12 14:43:14 deeplearn kubelet[2301]: E1012 14:43:14.519410 2301 kubelet.go:2248] node \"deeplearn\" not foundOct 12 14:43:14 deeplearn kubelet[2301]: E1012 14:43:14.592251 2301 reflector.go:125] k8s.io/client-go/informers/factory.go:133: Failed to list *v1beta1.RuntimeClass: Get https://ip:6443/apis/node.k8s.io/v1beta1/runtimeclasses?limit=500&amp;resourceVersion=0: dial tcp ip:6443: connect: connection refusedOct 12 14:43:14 deeplearn kubelet[2301]: E1012 14:43:14.619630 2301 kubelet.go:2248] node \"deeplearn\" not found æ²¡å‘ç°ä»€ä¹ˆæœ‰ä»·å€¼çš„ä¿¡æ¯ï¼Œäºæ˜¯åˆæŸ¥çœ‹äº†ç³»ç»Ÿæ—¥å¿— 123456789101112[root@deeplearn log]# tail -f messagesOct 12 10:37:49 deeplearn systemd-logind: New session 1080012 of user root.Oct 12 10:37:49 deeplearn systemd: Started Session 1080012 of user root.Oct 12 10:37:49 deeplearn systemd: Starting Session 1080012 of user root.Oct 12 10:37:50 deeplearn kubelet: E1012 10:37:50.044418 2544 kuberuntime_manager.go:887] PodSandboxStatus of sandbox \"06785948be010cf48cbef180389fd38199517ce1bab59351de39a69ff12b4859\" for pod \"etcd-deeplearn_kube-system(1fdca295cf61791ef3ce86ddb8403ba7)\" error: rpc error: code = Unknown desc = Error response from daemon: open /home/docker/overlay2/2a32175b96d1bd9a6bfc3ff7c484a50c31074f900e7c0fe205c78f1fca8fa417/lower: too many open filesOct 12 10:37:50 deeplearn kubelet: E1012 10:37:50.047370 2544 kuberuntime_manager.go:887] PodSandboxStatus of sandbox \"06785948be010cf48cbef180389fd38199517ce1bab59351de39a69ff12b4859\" for pod \"etcd-deeplearn_kube-system(1fdca295cf61791ef3ce86ddb8403ba7)\" error: rpc error: code = Unknown desc = Error response from daemon: open /home/docker/overlay2/2a32175b96d1bd9a6bfc3ff7c484a50c31074f900e7c0fe205c78f1fca8fa417/lower: too many open filesOct 12 10:37:50 deeplearn systemd-logind: Removed session 1080012.Oct 12 10:37:50 deeplearn kubelet: E1012 10:37:50.148623 2544 reflector.go:125] object-\"kube-system\"/\"gpushare-device-plugin-token-sf97m\": Failed to list *v1.Secret: Get https://ip:6443/api/v1/namespaces/kube-system/secrets?fieldSelector=metadata.name%3Dgpushare-device-plugin-token-sf97m&amp;limit=500&amp;resourceVersion=0: dial tcp ip:6443: connect: connection refusedOct 12 10:37:50 deeplearn kubelet: E1012 10:37:50.290671 2544 event.go:249] Unable to write event: 'Patch https://ip:6443/api/v1/namespaces/kube-system/events/etcd-deeplearn.163d0410148c7455: dial tcp ip:6443: connect: connection refused' (may retry after sleeping)Oct 12 10:37:50 deeplearn kubelet: E1012 10:37:50.347797 2544 reflector.go:125] object-\"kube-system\"/\"kube-proxy-token-8fbbs\": Failed to list *v1.Secret: Get https://ip:6443/api/v1/namespaces/kube-system/secrets?fieldSelector=metadata.name%3Dkube-proxy-token-8fbbs&amp;limit=500&amp;resourceVersion=0: dial tcp ip:6443: connect: connection refusedOct 12 10:37:50 deeplearn kubelet: E1012 10:37:50.547603 2544 reflector.go:125] k8s.io/kubernetes/pkg/kubelet/kubelet.go:444: Failed to list *v1.Service: Get https://ip:6443/api/v1/services?limit=500&amp;resourceVersion=0: dial tcp ip:6443: connect: connection refusedOct 12 10:37:50 deeplearn kubelet: W1012 10:37:50.747777 2544 status_manager.go:485] Failed to get status for pod \"kube-controller-manager-deeplearn_kube-system(ba945724332cd7f7efca6f11bdcf8307)\": Get https://ip:6443/api/v1/namespaces/kube-system/pods/kube-controller-manager-deeplearn: dial tcp ip:6443: connect: connection refused å‘ç°äº†å¯ç–‘æ—¥å¿—too many open files too many open filesæ˜¯Linuxç³»ç»Ÿä¸­å¸¸è§çš„é”™è¯¯ï¼Œä»å­—é¢æ„æ€ä¸Šçœ‹å°±æ˜¯è¯´ç¨‹åºæ‰“å¼€çš„æ–‡ä»¶æ•°è¿‡å¤šï¼Œä¸è¿‡è¿™é‡Œçš„filesä¸å•æ˜¯æ–‡ä»¶çš„æ„æ€ï¼Œä¹ŸåŒ…æ‹¬æ‰“å¼€çš„é€šè®¯é“¾æ¥(æ¯”å¦‚socket)ï¼Œæ­£åœ¨ç›‘å¬çš„ç«¯å£ç­‰ç­‰ï¼Œæ‰€ä»¥æœ‰æ—¶å€™ä¹Ÿå¯ä»¥å«åšå¥æŸ„(handle)ï¼Œè¿™ä¸ªé”™è¯¯é€šå¸¸ä¹Ÿå¯ä»¥å«åšå¥æŸ„æ•°è¶…å‡ºç³»ç»Ÿé™åˆ¶ã€‚ æ˜¯å“ªä¸ªè¿›ç¨‹å ç”¨äº†è¿‡å¤šçš„å¥æŸ„ï¼Ÿ å‘ç°docker å’Œk8s å æ®å‰ä¸¤å(8225æ˜¯ä¸€ä¸ªä¸šåŠ¡è¿›ç¨‹) 1234[root@deeplearn ~]# lsof -n|awk '&#123;print $2&#125;'|sort|uniq -c|sort -nr|more5901300 27593 20532 1081 17152 8225 2.æ¸…ç†ç³»ç»Ÿå¥æŸ„â€‹ å°è¯•ä½¿ç”¨docker system dfæ¸…ç†ä¹Ÿæç¤ºerror reading dir entries: open /run/docker/plugins: too many open filesï¼ˆä½¿ç”¨ulimit -aæŸ¥è¯¢open fileså‚æ•°å·²è°ƒè‡³ç³»ç»Ÿä¸Šé™ï¼‰ï¼Œæ²¡åŠæ³•åªæœ‰å…ˆåœæ­¢åé¢çš„ä¸šåŠ¡è¿›ç¨‹äº†ã€‚ â€‹ æ€æ‰ä¸šåŠ¡ç³»ç»Ÿï¼Œæ‰§è¡Œdocker æ¸…ç†å‘½ä»¤ï¼Œæ–‡ä»¶å¥æŸ„æ•°ä¸‹é™ä½†k8sä¾ç„¶æ²¡æœ‰æ¢å¤æ­£å¸¸ã€‚ã€‚ã€‚ 123456docker system prune docker image prunedocker container prunedocker volume prune docker network prunedocker rmi $(docker images -q) 3.å¯¼å…¥åŸºç¡€é•œåƒâ€‹ åˆ°è¿™é‡Œé—®é¢˜çº¿ç´¢åˆæ–­äº†ï¼Œæ²¡åŠæ³•å†ä¸Šç½‘æŸ¥æŸ¥çœ‹çœ‹æœ‰æ²¡æœ‰ç±»ä¼¼çš„é—®é¢˜ç°è±¡å§ã€‚åœ¨ä¸€ç¯‡blogä¸­å‘ç°äº†ç±»ä¼¼çš„æ—¥å¿—ã€Šé—®é¢˜â€œThe connection to the serverâ€¦.:6443 was refused - did you specify the right host or port?â€çš„å¤„ç†ï¼ã€‹ã€‚ æŒ‰ç…§blogä¸­çš„è§£å†³æ–¹æ³•â€“é‡æ–°å¯¼å…¥åŸºç¡€é•œåƒ,é—®é¢˜è§£å†³ï¼ ä¸‰ã€é—®é¢˜æ€»ç»“ â€‹ åŸºç¡€é•œåƒæ— æ•…æ¶ˆå¤±ï¼Œå¯¼è‡´é—®é¢˜äº§ç”Ÿã€‚ â€‹ ç³»ç»Ÿæ–‡ä»¶å¥æŸ„æ•°è¿‡é«˜,å¯¼è‡´ç³»ç»ŸæœåŠ¡å¼‚å¸¸ã€‚","categories":[],"tags":[{"name":"K8S","slug":"K8S","permalink":"https://zhangjunjunah.github.io/tags/K8S/"}]},{"title":"Javaæ“ä½œdockeræ­¥éª¤åŠé—®é¢˜æ€»ç»“","slug":"Javaæ“ä½œdockeræ­¥éª¤åŠé—®é¢˜æ€»ç»“","date":"2020-07-18T05:33:06.000Z","updated":"2020-07-18T07:47:00.223Z","comments":true,"path":"2020/07/18/Javaæ“ä½œdockeræ­¥éª¤åŠé—®é¢˜æ€»ç»“/","link":"","permalink":"https://zhangjunjunah.github.io/2020/07/18/Java%E6%93%8D%E4%BD%9Cdocker%E6%AD%A5%E9%AA%A4%E5%8F%8A%E9%97%AE%E9%A2%98%E6%80%BB%E7%BB%93/","excerpt":"","text":"ä¸€ã€å‰è¨€â€‹ è¿™æ®µæ—¶é—´ä¸€ç›´åœ¨ä½¿ç”¨dockerå’Œkubernetesï¼Œæœ€è¿‘äº§å“æœ‰ä¸ªéœ€æ±‚åœ¨ä¸šåŠ¡ä¸Šè¿­ä»£é•œåƒï¼Œéœ€è¦é€šè¿‡Java è¿œç¨‹æ“ä½œdockerã€‚æˆ‘æƒ³è¿™ç§æ–¹æ¡ˆç½‘ä¸Šåº”è¯¥æŒºå¤šçš„ï¼Œå¾ˆå®¹æ˜“å®Œæˆï¼Œä½†å·¥ä½œä¸æ˜¯åƒæˆ‘æƒ³çš„é‚£æ ·é¡ºåˆ©ã€‚ã€‚ã€‚ä¸‹é¢é™„ä¸Šæ“ä½œæ­¥éª¤åŠé‡åˆ°çš„ä¸€äº›é—®é¢˜å’Œæˆ‘çš„è§£å†³æ€è·¯ã€‚ äºŒã€æ“ä½œæ­¥éª¤(å‚è€ƒç½‘ä¸Š)â€‹ æ­¤éƒ¨åˆ†ä¸»è¦å‚è€ƒç½‘ä¸Šçš„ä¸€äº›blog é…ç½®Dockerä¸¤å°dockerä¸»æœº(linux Centos 7)ï¼Œå…¶ä¸­ä¸€å°ä½¿ç”¨GPU(ä¸æ˜¯æˆ‘è´Ÿè´£çš„ï¼Œæœºå™¨ç¯å¢ƒä¸å¤ªç†Ÿï¼Œè¿™é‡Œç•™äº†ä¸€ä¸ªå‘) 1.ä¿®æ”¹docker.serviceï¼ŒExecStart=/usr/bin/dockerd æ·»åŠ ä¸Š -H tcp://0.0.0.0:2375 -H unix://var/run/docker.sock 12345678vi /lib/systemd/system/docker.service[Service]Type=notify# the default is not to use systemd for cgroups because the delegate issues still# exists and systemd currently does not support the cgroup feature set required# for containers run by docker#ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sockExecStart=/usr/bin/dockerd -H tcp://0.0.0.0:2375 -H unix://var/run/docker.sock 2.ä¿®æ”¹åä¿å­˜æ–‡ä»¶ï¼Œç„¶åé€šçŸ¥dockeræœåŠ¡åšå‡ºçš„ä¿®æ”¹ 12systemctl daemon-reloadservice docker restart 3.æµ‹è¯•ä½¿ç”¨dockerå‘½ä»¤è¿œç¨‹æ–¹å¼è®¿é—® 1docker -H tcp://ip:2375 images é…ç½®äº§å“ä½¿ç”¨docker-javadocker-javaæ¨èä½¿ç”¨mavené¡¹ç›®å¼•å…¥ç›¸å…³çš„jaråŒ…ä¾èµ–ï¼š 123456&lt;dependency&gt; &lt;groupId&gt;com.github.docker-java&lt;/groupId&gt; &lt;artifactId&gt;docker-java&lt;/artifactId&gt; &lt;!-- use latest version https://github.com/docker-java/docker-java/releases --&gt; &lt;version&gt;3.X.Y&lt;/version&gt;&lt;/dependency&gt; ä¸‰ã€é—®é¢˜è§£å†³æ–¹æ³•ä¸Šé¢çš„æ­¥éª¤é…ç½®ä¸å¤æ‚ï¼Œä½†å®é™…æ“ä½œåï¼Œè¿˜æ˜¯å‡ºç°äº†äº›é—®é¢˜ï¼Œåœ¨è¿™é‡Œè®°å½•ä¸€ä¸‹ã€‚ 1.åœ¨/lib/systemd/system/docker.serviceé…ç½®äº†-H tcp://0.0.0.0:2375 -H unix://var/run/docker.sockï¼Œä½†æ˜¯é…ç½®æ— æ•ˆ è§£å†³æ–¹æ³•: è¿›å…¥/etc/systemd/system/docker.service.dç›®å½•ï¼Œæ£€æŸ¥override.confæ–‡ä»¶æ˜¯å¦è¦†ç›–äº†[Service] ExecStartçš„é…ç½® 2.äº§å“é…ç½®äº†docker-java mavenä¾èµ–é¡¹ç›®è¿æ¥å¤±è´¥å¹¶æç¤ºæŠ¥é”™: 123456789Exception in thread \"main\" java.lang.NoSuchMethodError: javax.ws.rs.core.MultivaluedMap.addAll(Ljava/lang/Object;[Ljava/lang/Object;)V at org.glassfish.jersey.client.ClientRequest.accept(ClientRequest.java:336) at org.glassfish.jersey.client.JerseyInvocation$Builder.accept(JerseyInvocation.java:240) at org.glassfish.jersey.client.JerseyInvocation$Builder.accept(JerseyInvocation.java:163) at com.github.dockerjava.jaxrs.CommitCmdExec.execute(CommitCmdExec.java:35) at com.github.dockerjava.jaxrs.CommitCmdExec.execute(CommitCmdExec.java:15) at com.github.dockerjava.jaxrs.AbstrSyncDockerCmdExec.exec(AbstrSyncDockerCmdExec.java:23) at com.github.dockerjava.core.command.AbstrDockerCmd.exec(AbstrDockerCmd.java:35) at com.github.dockerjava.core.command.CommitCmdImpl.exec(CommitCmdImpl.java:347) è§£å†³æ–¹æ³•: â€‹ æ­¤é—®é¢˜çš„åŸå› æ˜¯jaråŒ…ç‰ˆæœ¬å†²çªï¼Œæ£€æŸ¥é¡¹ç›®ä¸­æ˜¯å¦ä½¿ç”¨äº†hadoopç›¸å…³jaråŒ…ï¼Œå»é™¤jersey-coreå’Œjersey-serverç›¸å…³ä¾èµ– 12345678910111213141516171819202122232425262728293031323334&lt;dependency&gt; &lt;groupId&gt;org.apache.hadoop&lt;/groupId&gt; &lt;artifactId&gt;hadoop-common&lt;/artifactId&gt; &lt;version&gt;$&#123;cdh.hadoop.version&#125;&lt;/version&gt; &lt;exclusions&gt; &lt;exclusion&gt; &lt;groupId&gt;com.sun.jersey&lt;/groupId&gt; &lt;artifactId&gt;jersey-core&lt;/artifactId&gt; &lt;/exclusion&gt; &lt;exclusion&gt; &lt;artifactId&gt;jersey-json&lt;/artifactId&gt; &lt;groupId&gt;com.sun.jersey&lt;/groupId&gt; &lt;/exclusion&gt; &lt;exclusion&gt; &lt;groupId&gt;com.sun.jersey&lt;/groupId&gt; &lt;artifactId&gt;jersey-server&lt;/artifactId&gt; &lt;/exclusion&gt; &lt;/exclusions&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.apache.hadoop&lt;/groupId&gt; &lt;artifactId&gt;hadoop-hdfs&lt;/artifactId&gt; &lt;version&gt;$&#123;cdh.hadoop.version&#125;&lt;/version&gt; &lt;exclusions&gt; &lt;exclusion&gt; &lt;groupId&gt;com.sun.jersey&lt;/groupId&gt; &lt;artifactId&gt;jersey-core&lt;/artifactId&gt; &lt;/exclusion&gt; &lt;exclusion&gt; &lt;groupId&gt;com.sun.jersey&lt;/groupId&gt; &lt;artifactId&gt;jersey-server&lt;/artifactId&gt; &lt;/exclusion&gt; &lt;/exclusions&gt;&lt;/dependency&gt; å››ã€è§£å†³æ€è·¯â€‹ ç¬¬ä¸‰éƒ¨åˆ†æ˜¯æˆ‘æ“ä½œè¿‡ç¨‹ä¸­é‡åˆ°çš„ä¸¤ä¸ªé—®é¢˜çš„è§£å†³æ–¹æ³•ï¼Œè§£å†³æ–¹æ³•çœ‹ä¸Šå»ä¹ŸæŒºç®€å•çš„ï¼Œä½†è§£å†³çš„è¿‡ç¨‹ä¹Ÿæ¯”è¾ƒçš„å¿ƒé…¸(æ°´å¹³æœ‰å¾…æé«˜)ï¼Œç‰¹æ„è®°å½•ä¸‹ã€‚ â€‹ 1.GPUä¸»æœºé…ç½®äº†Dockerè¿œç¨‹è®¿é—®ï¼Œä½†é…ç½®æ— æ•ˆã€‚ã€‚ã€‚ å½“æ—¶ç¬¬ä¸€ååº”æ˜¯çœ‹çœ‹æœ‰æ²¡æœ‰å…¶ä»–çš„é…ç½®æ–¹æ³•ï¼Œå¯èƒ½GPUä¸»æœºé…ç½®äº†nvidiaçš„ç›¸å…³ä¿¡æ¯ï¼Œæ¢ç§æ–¹æ³•è¯•è¯•ã€‚ä¿®æ”¹/etc/docker/daemon.jsonï¼Œæ·»åŠ é”®å€¼å¯¹ &quot;hosts&quot;: [&quot;0.0.0.0:2375&quot;,&quot;unix:///var/run/docker.sock&quot;]ï¼Œä½†äº‹ä¸æ„¿è¿ï¼Œè¿™ç§æ–¹å¼dockerå‹æ ¹å¯åŠ¨ä¸äº†ã€‚åœ¨æ·»åŠ è¿™æ®µå†…å®¹æ—¶ï¼Œä¹Ÿå‘ç°äº†ç°è±¡ï¼Œå³ä½¿æˆ‘æŠŠdeamon.jsoné‡Œçš„é…ç½®éƒ½åˆ äº†ï¼Œé€šè¿‡systemctl status dockerè¿˜æ˜¯èƒ½å¤Ÿçœ‹åˆ°dockerd --host=fd:// --add-runtime=nvidia=/usr/bin/nvidia-container-runtimeã€‚ ç”±äºå½“æ—¶è¿˜æœ‰å…¶ä»–ä»»åŠ¡ï¼Œå°±å‘å½“æ—¶å®‰è£…è¿™å°GPUä¸»æœºdockerçš„åŒäº‹è¯·æ±‚ååŠ©ï¼Œå¯èƒ½æœ‰å•¥ç‰¹æ®Šé…ç½®æˆ‘ä¸çŸ¥é“ã€‚è¿‡äº†ä¸¤å¤©ï¼Œæˆ‘è¿™è¾¹ç´§æ€¥çš„äº‹å¿™å®Œäº†ï¼Œå›è¿‡æ¥è§£å†³é—ç•™çš„é—®é¢˜ï¼Œè‡ªå·±çš„äº‹è¦è´Ÿè´£åˆ°åº•å•Š(ä¸‹é¢é‡ç‚¹æ¥äº†)ã€‚ â€‹ æˆ‘è‡ªå·±è¿˜æ˜¯åšæŒè®¤ä¸ºæ˜¯æœ‰å•¥ç‰¹æ®Šé…ç½®å¯¼è‡´è¿™é‡Œä¸ç”Ÿæ•ˆï¼ŒäºŒè¯ä¸è¯´æˆ‘å…¨å±€æœä¸€ä¸‹dockerç›¸å…³çš„é…ç½®æ–‡ä»¶ä¸å°±è¡Œäº†ï¼Œfind . -name *docker*,ä¾æ¬¡æ£€æŸ¥äº†ç›¸å…³çš„é…ç½®æ²¡å‘ç°ä»€ä¹ˆé—®é¢˜ã€‚ä¸Šç½‘æœäº†ä¸‹dockeræœ‰å“ªäº›é…ç½®æ–‡ä»¶ï¼Œä¾ç„¶æ²¡ä»€ä¹ˆæ”¶è·ã€‚è¿™é‡Œæœ‰ç‚¹å¤´å¤§ï¼Œäºæ˜¯æˆ‘æ¢äº†ä¸€ç§æ€è·¯æ£€æŸ¥é—®é¢˜ï¼Œæˆ‘ä¸æ˜¯é…ç½®äº†ä¸¤å°ä¸»æœºäº†ï¼Œé‚£å°CPUæœºå™¨å¯ä»¥æ­£å¸¸ä½¿ç”¨äºæ˜¯æˆ‘åˆ†åˆ«ç”¨docker infoå’Œsystemctl status dockerå‘½ä»¤æŸ¥çœ‹ä¸¤å°ä¸»æœºæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œç»ˆäºåœ¨æ‰§è¡Œäº†systemctl status dockerå‘ç°äº†äº›åŒºåˆ«ã€‚ 1234567891011121314151617181920212223242526272829 #GPUæœºå™¨ systemctl status docker -lâ— docker.service - Docker Application Container Engine Loaded: loaded (/usr/lib/systemd/system/docker.service; enabled; vendor preset: disabled) Drop-In: /etc/systemd/system/docker.service.d â””â”€override.conf Active: active (running) since Sat 2020-07-18 11:37:53 CST; 1h 39min ago Docs: https://docs.docker.com Main PID: 19626 (dockerd) Tasks: 91 Memory: 183.1M CGroup: /system.slice/docker.service â”œâ”€19626 /usr/bin/dockerd --host=fd:// --add-runtime=nvidia=/usr/bin/nvidia-container-runtime â”œâ”€19865 /usr/bin/docker-proxy -proto tcp -host-ip 0.0.0.0 -host-port 20000 -container-ip 192.167.0.3 -container-port 20000 â”œâ”€21907 /usr/bin/docker-proxy -proto tcp -host-ip 0.0.0.0 -host-port 9380 -container-ip 192.167.0.2 -container-port 9380 â””â”€21925 /usr/bin/docker-proxy -proto tcp -host-ip 0.0.0.0 -host-port 9360 -container-ip 192.167.0.2 -container-port 9360 #CPUæœºå™¨ systemctl status docker -lâ— docker.service - Docker Application Container Engine Loaded: loaded (/usr/lib/systemd/system/docker.service; enabled; vendor preset: disabled) Active: active (running) since Tue 2020-07-14 16:09:34 CST; 3 days ago Docs: https://docs.docker.com Main PID: 17952 (dockerd) Tasks: 92 Memory: 1.4G CGroup: /system.slice/docker.service â”œâ”€17952 /usr/bin/dockerd -H tcp://0.0.0.0:2375 -H unix://var/run/docker.sock â””â”€18512 /usr/bin/docker-proxy -proto tcp -host-ip 127.0.0.1 -host-port 1514 -container-ip 172.18.0.7 -container-port 10514 GPUæœºå™¨å¤šäº†ä¸€æ®µDrop-In,æŸ¥çœ‹override.conf,å‘ç°äº†é—®é¢˜æ‰€åœ¨ï¼Œè¿™é‡Œè¦†å†™äº†ExecStartç›¸å…³é…ç½®ï¼Œè‡³æ­¤è¿™ä¸ªé—®é¢˜ç»ˆäºè§£å†³äº†ã€‚ 12Drop-In: /etc/systemd/system/docker.service.d â””â”€override.conf","categories":[],"tags":[{"name":"Docker","slug":"Docker","permalink":"https://zhangjunjunah.github.io/tags/Docker/"},{"name":"Java","slug":"Java","permalink":"https://zhangjunjunah.github.io/tags/Java/"}]},{"title":"flannelç»„ä»¶æŒ‚äº†å¯¼è‡´k8sç½‘ç»œé€šä¿¡å¤±è´¥","slug":"flannelç»„ä»¶æŒ‚äº†å¯¼è‡´k8sç½‘ç»œé€šä¿¡å¤±è´¥","date":"2020-06-09T02:34:53.633Z","updated":"2020-06-09T02:34:53.633Z","comments":true,"path":"2020/06/09/flannelç»„ä»¶æŒ‚äº†å¯¼è‡´k8sç½‘ç»œé€šä¿¡å¤±è´¥/","link":"","permalink":"https://zhangjunjunah.github.io/2020/06/09/flannel%E7%BB%84%E4%BB%B6%E6%8C%82%E4%BA%86%E5%AF%BC%E8%87%B4k8s%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1%E5%A4%B1%E8%B4%A5/","excerpt":"","text":"","categories":[],"tags":[]},{"title":"docker é•œåƒç˜¦èº«(commit æ–¹å¼åˆ¶ä½œçš„é•œåƒ)","slug":"docker é•œåƒç˜¦èº«(commit æ–¹å¼åˆ¶ä½œçš„é•œåƒ)","date":"2020-04-22T16:00:00.000Z","updated":"2020-04-23T06:20:04.649Z","comments":true,"path":"2020/04/23/docker é•œåƒç˜¦èº«(commit æ–¹å¼åˆ¶ä½œçš„é•œåƒ)/","link":"","permalink":"https://zhangjunjunah.github.io/2020/04/23/docker%20%E9%95%9C%E5%83%8F%E7%98%A6%E8%BA%AB(commit%20%E6%96%B9%E5%BC%8F%E5%88%B6%E4%BD%9C%E7%9A%84%E9%95%9C%E5%83%8F)/","excerpt":"","text":"èƒŒæ™¯â€‹ æ ¹æ®äº§å“çš„è¿è¡Œä½œä¸šçš„ç‰¹ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦åˆ¶ä½œä¸€äº›ä¸šåŠ¡é•œåƒï¼Œå°†ä½œä¸šæ”¾åˆ°å®¹å™¨ä¸­æ‰§è¡Œã€‚ç”±äºåˆ¶ä½œè¿è¡Œç¯å¢ƒè¦ä¸æ–­è°ƒè¯•ï¼Œæˆ‘ä»¬æ˜¯é€šè¿‡å¤§è‡´(æœ‰çœç•¥)ä»¥ä¸‹æ­¥éª¤åˆ¶ä½œçš„: å¯åŠ¨ä¸€ä¸ªç©ºå®¹å™¨(ubuntu) å®‰è£…python/pip å®‰è£…ç±»åº“ å°†ä½œä¸šæ”¾åˆ°å®¹å™¨ä¸­æµ‹è¯•;å¦‚æœæµ‹è¯•é€šè¿‡ï¼Œdocker commit æ–¹å¼æäº¤é•œåƒ â€‹ åœ¨è¿™é‡Œè¦åæ€ä¸‹ï¼Œå½“æ—¶ç”±äºæ²¡æœ‰å……åˆ†è°ƒç ”dockeré•œåƒæ­£ç¡®çš„åˆ¶ä½œæ–¹å¼ï¼Œå¯¼è‡´åæœŸè¿­ä»£é•œåƒè¶Šæ¥è¶Šå¤§(10G+)ï¼Œä»¥åŠæƒ³é‡æ–°åˆ¶ä½œå´æ²¡æœ‰äº†å‰é¢ç‰ˆæœ¬çš„åˆ¶ä½œè½¨è¿¹ã€‚ â€‹ è¿‘æœŸï¼Œç”±äºäº§å“è¦åœ¨ä¸€ä¸ªç§æœ‰ç¯å¢ƒéƒ¨ç½²ï¼Œé•œåƒå¤ªå¤§ä¼ è¾“å¤ªæ…¢ï¼Œæ‰€ä»¥æœ‰äº†é•œåƒç˜¦èº«çš„æƒ³æ³•ã€‚ æ­¥éª¤ è¿è¡Œå®¹å™¨å¹¶è¿›å…¥ï¼ŒæŸ¥çœ‹ç£ç›˜å ç”¨ï¼Œåˆ é™¤ä¸éœ€è¦çš„æ•°æ® 12345678#è¿è¡Œå®¹å™¨å¹¶è¿›å…¥å®¹å™¨æ ·ä¾‹docker run -d --name ubuntu ubuntu:15.10docker exec -i -t ubuntu /bin/bash#è¿›å…¥æ ¹ç›®å½•cd / #æŸ¥çœ‹å„ä¸ªç›®å½•ä½“ç§¯du -h -d 1#åˆ é™¤ä¸éœ€è¦çš„æ•°æ®(ç•¥) åœ¨å®¹å™¨æ ¹ç›®å½•æ‰“åŒ…å®¹å™¨æ•°æ®(å‰”é™¤/procã€/sysç›®å½•) 1234#é€šè¿‡taræ–¹å¼æ‰“åŒ…tar --exclude=proc --exclude=sys --exclude=base_img.tar -cvf images.tar .#å®Œæˆåé€€å‡ºå®¹å™¨exit å°†å®¹å™¨å†…çš„taråŒ…æ‹·è´å‡ºæ¥ï¼Œå†å°†é•œåƒé‡æ–°å¯¼å…¥ 1234#æ‹·è´å®¹å™¨ä¸­çš„æ–‡ä»¶åˆ°å®¿ä¸»æœºä¸­docker cp ubuntu:/images.tar .#å°†é•œåƒé‡æ–°å¯¼å…¥cat images.tar|docker import - new-ubuntu å®Œæˆç˜¦èº«ï¼Œæ¯”è¾ƒç˜¦èº«å‰åçš„ä½“ç§¯ 1docker images |grep new-ubuntu å‚è€ƒåšæ–‡dockerå®¹å™¨commitçš„é•œåƒè¶Šæ¥è¶Šå¤§æ€ä¹ˆåŠï¼Ÿé…±ç´«è¯•è¯•","categories":[],"tags":[{"name":"Docker","slug":"Docker","permalink":"https://zhangjunjunah.github.io/tags/Docker/"}]},{"title":"Log4J2.xmlè‡ªç”¨é…ç½®","slug":"Log4J2.xmlè‡ªç”¨é…ç½®","date":"2020-04-20T13:53:40.000Z","updated":"2020-04-21T03:07:34.360Z","comments":true,"path":"2020/04/20/Log4J2.xmlè‡ªç”¨é…ç½®/","link":"","permalink":"https://zhangjunjunah.github.io/2020/04/20/Log4J2.xml%E8%87%AA%E7%94%A8%E9%85%8D%E7%BD%AE/","excerpt":"","text":"å‰è¨€â€‹ log4j2çš„é…ç½®æ–‡ä»¶ç½‘ä¸Šä¸€æœå¾ˆå®¹æ˜“æœåˆ°ï¼Œè¿™é‡Œä¸»è¦å°±æ˜¯è®°å½•ä¸‹è‡ªå·±å¼€å‘ä¸­ç»å¸¸ä½¿ç”¨çš„ä¸€å¥—é…ç½®ï¼Œæ–¹ä¾¿ä»¥åæŸ¥æ‰¾ã€‚ é…ç½®æ–‡ä»¶è¯¦æƒ…123456789101112131415161718192021222324252627282930313233343536373839404142434445464748&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;&lt;!--Configurationåé¢çš„statusï¼Œè¿™ä¸ªç”¨äºè®¾ç½®log4j2è‡ªèº«å†…éƒ¨çš„ä¿¡æ¯è¾“å‡ºï¼Œå¯ä»¥ä¸è®¾ç½®ï¼Œå½“è®¾ç½®æˆtraceæ—¶ï¼Œä½ ä¼šçœ‹åˆ°log4j2å†…éƒ¨å„ç§è¯¦ç»†è¾“å‡º--&gt;&lt;!--monitorIntervalï¼šLog4jèƒ½å¤Ÿè‡ªåŠ¨æ£€æµ‹ä¿®æ”¹é…ç½® æ–‡ä»¶å’Œé‡æ–°é…ç½®æœ¬èº«ï¼Œè®¾ç½®é—´éš”ç§’æ•°--&gt;&lt;configuration status=\"error\" monitorInterval=\"30\"&gt; &lt;!--å…¨å±€å‚æ•°--&gt; &lt;Properties&gt; &lt;Property name=\"pattern\"&gt;[%style&#123;%d&#125;&#123;bright,green&#125;][%highlight&#123;%p&#125;][%style&#123;%t&#125;&#123;bright,blue&#125;][%style&#123;%C.%M:%L&#125;&#123;bright,yellow&#125;]: %msg%n%style&#123;%throwable&#125;&#123;red&#125;&lt;/Property&gt; &lt;Property name=\"logDir\"&gt;$&#123;env:IM_HOME&#125;/logs&lt;/Property&gt; &lt;Property name=\"disableAnsi\"&gt;false&lt;/Property&gt; &lt;/Properties&gt; &lt;Loggers&gt; &lt;Root level=\"INFO\"&gt; &lt;AppenderRef ref=\"console\"/&gt; &lt;AppenderRef ref=\"rolling_file\"/&gt; &lt;/Root&gt; &lt;/Loggers&gt; &lt;Appenders&gt; &lt;!-- å®šä¹‰è¾“å‡ºåˆ°æ§åˆ¶å° --&gt; &lt;Console name=\"console\" target=\"SYSTEM_OUT\" follow=\"true\"&gt; &lt;!--æ§åˆ¶å°åªè¾“å‡ºlevelåŠä»¥ä¸Šçº§åˆ«çš„ä¿¡æ¯--&gt; &lt;ThresholdFilter level=\"DEBUG\" onMatch=\"ACCEPT\" onMismatch=\"DENY\"/&gt; &lt;PatternLayout &gt; &lt;Pattern&gt;$&#123;pattern&#125;&lt;/Pattern&gt; &lt;/PatternLayout&gt; &lt;/Console&gt; &lt;!-- åŒä¸€æ¥æºçš„Appenderå¯ä»¥å®šä¹‰å¤šä¸ªRollingFileï¼Œå®šä¹‰æŒ‰å¤©å­˜å‚¨æ—¥å¿— --&gt; &lt;RollingFile name=\"rolling_file\" fileName=\"$&#123;logDir&#125;/im-server.log\" filePattern=\"$&#123;logDir&#125;/im-server_%d&#123;yyyy-MM-dd&#125;.log\"&gt; &lt;ThresholdFilter level=\"INFO\" onMatch=\"ACCEPT\" onMismatch=\"DENY\"/&gt; &lt;PatternLayout&gt; &lt;Pattern&gt;$&#123;pattern&#125;&lt;/Pattern&gt; &lt;/PatternLayout&gt; &lt;Policies&gt; &lt;TimeBasedTriggeringPolicy interval=\"1\"/&gt; &lt;/Policies&gt; &lt;!-- æ—¥å¿—ä¿ç•™ç­–ç•¥ï¼Œé…ç½®åªä¿ç•™ä¸ƒå¤© --&gt; &lt;DefaultRolloverStrategy&gt; &lt;Delete basePath=\"$&#123;logDir&#125;/\" maxDepth=\"1\"&gt; &lt;IfFileName glob=\"im-server_*.log\" /&gt; &lt;IfLastModified age=\"7d\" /&gt; &lt;/Delete&gt; &lt;/DefaultRolloverStrategy&gt; &lt;/RollingFile&gt; &lt;/Appenders&gt;&lt;/configuration&gt; è¯´æ˜ æ§åˆ¶å°æ—¥å¿—é«˜äº®è®¾ç½®(IDEä¸ºIDEA),åœ¨å¯åŠ¨ä¸»ç±»VM options ä¸­æ·»åŠ ä¸€è¡Œå‚æ•°:-Dlog4j.skipJansi=false åœ¨logDirå±æ€§é…ç½®ä¸­å¯ä»¥é€šè¿‡å¯åŠ¨ç±»çš„ç¯å¢ƒå˜é‡(Environment variables)è®¾ç½®IM_HOMEè·¯å¾„","categories":[],"tags":[{"name":"Log4J2","slug":"Log4J2","permalink":"https://zhangjunjunah.github.io/tags/Log4J2/"}]},{"title":"Spring AOPç»“åˆè‡ªå®šä¹‰æ³¨è§£å®ä¾‹","slug":"spring AOPç»“åˆè‡ªå®šä¹‰æ³¨è§£å®ä¾‹","date":"2020-03-30T16:00:00.000Z","updated":"2020-04-21T02:57:39.846Z","comments":true,"path":"2020/03/31/spring AOPç»“åˆè‡ªå®šä¹‰æ³¨è§£å®ä¾‹/","link":"","permalink":"https://zhangjunjunah.github.io/2020/03/31/spring%20AOP%E7%BB%93%E5%90%88%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B3%A8%E8%A7%A3%E5%AE%9E%E4%BE%8B/","excerpt":"","text":"ä½¿ç”¨èƒŒæ™¯â€‹ è¿‘æœŸåŒäº‹ä½¿ç”¨äº§å“ç»å¸¸é‡åˆ°é¡µé¢ç‚¹å‡»å¡æ­»é•¿æ—¶é—´æœªå“åº”ç°è±¡(æœ¬äººæ¯”è¾ƒæ“…é•¿è§£å†³é—®é¢˜)ï¼Œå¿ƒé‡Œå¸¦ç€ç–‘é—®ä½¿ç”¨jstackå‘½ä»¤æŸ¥çœ‹jvmå †æ ˆï¼Œå‘ç°é˜»å¡çš„çº¿ç¨‹éƒ½æ˜¯è¡¨æ›´æ–°æ“ä½œ(update)ã€‚æŸ¥çœ‹äº†ä¸‹ä»£ç å‘ç°æ˜¯ç”±äºæœ€è¿‘å¤§å®¶ç”³è¯·å®¹å™¨èµ„æºé¢‘ç¹ï¼Œç”³è¯·å®¹å™¨é€»è¾‘åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œåˆå› ä¸ºèµ„æºå‘Šè­¦åˆ›å»ºæ—¶é—´å˜é•¿ï¼Œå¯¼è‡´é”è¡¨ã€‚åœ¨è¿™é‡Œç®€å•è¯´ä¸‹ç”³è¯·å®¹å™¨çš„æ­¥éª¤ã€‚ å®Œæˆèµ„æºç”³è¯·åˆæ³•æ ¡éªŒï¼Œæ›´æ–°èµ„æºè¡¨ä¿¡æ¯ é€šè¿‡k8sApiåˆ›å»ºéœ€è¦çš„èµ„æº(podã€deploymentã€jobã€â€¦) â€“åœ¨èµ„æºç´§å¼ æ—¶åˆ›å»ºæ—¶é—´è¾ƒé•¿ åˆ›å»ºå¤±è´¥åˆ é™¤å¯¹åº”çš„k8sèµ„æº å¤‡æ³¨ï¼šèµ„æºè¡¨è®°å½•äº†å®¹å™¨å¹³å°èµ„æºæ€»å…±å¤šå°‘èµ„æºï¼ˆCPUã€GPUã€memoryï¼‰ï¼Œå·²ä½¿ç”¨å¤šå°‘ç­‰ä¿¡æ¯ é€»è¾‘å¾ˆç®€å•ï¼Œä½†åˆ›å»ºå®¹å™¨é¢‘ç¹å®¹æ˜“é€ æˆé”è¡¨ï¼Œå¯¼è‡´é¡µé¢å¡æ­»ã€‚æ”¹é€ æ–¹æ¡ˆä¹Ÿå¾ˆç®€å•ï¼Œæ›´æ–°èµ„æºè¡¨ä¸èµ°äº‹åŠ¡ï¼Œå¦‚æœåˆ›å»ºé€»è¾‘å¤±è´¥ï¼Œæ‰‹åŠ¨å›æ»šï¼Œä¸å°±å¯ä»¥äº†ã€‚ä»£ç†è®¾è®¡æ¨¡å¼æœ€é€‚åˆè¿™ç§æ”¹é€ åœºæ™¯ï¼Œè¯ä¸å¤šè¯´èµ¶ç´§åŠ¨æ‰‹ã€‚ ä½¿ç”¨å®ä¾‹åˆ›å»ºæ³¨è§£123456789101112/*** @Description: ç”³è¯·å®¹å™¨(æœåŠ¡)èµ„æºæ³¨è§£* @Param:* @return:* @Author: zhangjj* @Date: 2020-02-25*/@Retention(RetentionPolicy.RUNTIME)@Target(ElementType.METHOD)public @interface ApplyContainerRes &#123;&#125; ç¼–å†™åˆ‡é¢åœ¨è¿™é‡Œåªæ”¾ä¸Šäº†ç›¸å…³çš„ä»£ç ï¼ˆåŒ…åæ¶‰åŠå…¬å¸æš‚æ—¶å±è”½äº†ï¼‰ 1234567891011121314151617181920212223242526272829303132333435363738394041/** * @Description: ç”³è¯·èµ„æºåˆ‡é¢ * @ClassName: ApplyContainerResAspect * @Author: zhangjj * @Date: 2020-02-25 */@Aspect@Component@Slf4jpublic class ApplyContainerResAspect &#123; @Autowired private DataSourceTransactionManager dataSourceTransactionManager; @Pointcut(\"@annotation(xx.ApplyContainerRes)\") public void annotationApplyContainerResPointCut()&#123; &#125; @Before(\"annotationApplyContainerResPointCut()\") public void doBefore(JoinPoint joinPoint) &#123; DefaultTransactionDefinition def = new DefaultTransactionDefinition(); //æ–°å‘èµ·ä¸€ä¸ªäº‹åŠ¡ def.setPropagationBehavior(TransactionDefinition.PROPAGATION_REQUIRES_NEW); TransactionStatus transaction = dataSourceTransactionManager.getTransaction(def); //ä¼ªä»£ç  //ç”³è¯·èµ„æº(æ›´æ–°èµ„æºè¡¨ä¿¡æ¯) applyRes(joinPoint); dataSourceTransactionManager.commit(transaction); &#125; @AfterThrowing(\"annotationApplyContainerResPointCut()\") public void doAfter(JoinPoint joinPoint) &#123; DefaultTransactionDefinition def = new DefaultTransactionDefinition(); //æ–°å‘èµ·ä¸€ä¸ªäº‹åŠ¡ def.setPropagationBehavior(TransactionDefinition.PROPAGATION_REQUIRES_NEW); TransactionStatus transactionStatus = dataSourceTransactionManager.getTransaction(def); //ä¼ªä»£ç  //é‡Šæ”¾èµ„æº(æ›´æ–°èµ„æºè¡¨ä¿¡æ¯) releaseResource(joinPoint); dataSourceTransactionManager.commit(transactionStatus); &#125;&#125; ä¸šåŠ¡ä½¿ç”¨serviceå±‚ä¸šåŠ¡é€»è¾‘æ ·ä¾‹ 12345678910111213141516/*** @Description: å¯åŠ¨æœåŠ¡* @Param: [environmentId,modelServices]* @return: OperContainerResult* @Author: zhangjj* @Date: 2019-08-07*/@Override@ApplyContainerRespublic OperContainerResult startServing(Long environmentId, ModelServices modelServices) &#123; OperContainerResult operContainerResult = new OperContainerResult(); //æœåŠ¡éƒ¨ç½² deployModelService(modelServices); operContainerResult.setCode(OperContainerResult.CODE.SUCCESS); return operContainerResult;&#125; æ”¹é€ å®Œæˆï¼Œæµ‹è¯•é€šè¿‡ï¼å¾ˆé¡ºåˆ©å˜›(æ‰‹åŠ¨æ€€ç–‘)ï¼Œå¯ä»¥è®©åŒäº‹ä»¿ç…§ä¸Šé¢æ ·ä¾‹æ”¹é€ å…¶ä»–ä¸šåŠ¡é€»è¾‘äº†ã€‚ ä½¿ç”¨ä¸­çš„é—®é¢˜â€‹ åŒäº‹çš„æ”¹é€ é€Ÿåº¦ä¹Ÿå¾ˆå¿«ï¼Œæœ¬åœ°æµ‹è¯•å‘ç°ä¸å¯¹ï¼Œèµ„æºè¡¨çš„æ•°æ®æ€ä¹ˆæ²¡æ›´æ–°å•Šï¼æˆ‘è¿™è¾¹å¿ƒæƒ³å’‹å›äº‹ï¼Œæˆ‘è¿™è¾¹ä½¿ç”¨éƒ½å¥½ä½¿ï¼Œæ€ä¹ˆä½ è¿™å´ä¸å¥½ä½¿äº†ã€‚ã€‚ã€‚ä¸€èµ·æŸ¥çœ‹é€»è¾‘ï¼Œå‘ç°ä»–é‚£çš„é€»è¾‘æ˜¯åœ¨åŒä¸€ä¸ªç±»ä¸­è°ƒç”¨ã€‚æˆ‘è¿™è¾¹æ„è¯†åˆ°åŠ¨æ€ä»£ç†å¥½åƒä¸èƒ½ä»£ç†ç±»ä¸­æ–¹æ³•çš„ç›´æ¥è°ƒç”¨ï¼Œç½‘ä¸Šæœæœçœ‹çœ‹æœ‰æ²¡æœ‰è§£å†³æ–¹æ³•,å¾ˆå¿«æ‰¾åˆ°äº†è§£å†³åŠæ³•ã€‚ æœªè°ƒæ•´å‰ä»£ç  1234567891011121314151617181920/** * @param batchWorkId * @Description: æ‰¹é‡ä½œä¸šè¿è¡Œ * @Param: [batchWorkId] * @return: void * @Author: zhangjj * @Date: 2020-01-03 */@Overridepublic void runBatchWork(Long batchWorkId) &#123; //å…¶ä»–ä¸šåŠ¡ dosomething(); //è°ƒç”¨è¢«ä»£ç†çš„ä»£ç†ç±» doRunBatchWork(batchWorkId);&#125;@ApplyContainerRespublic void doRunBatchWork(batchWorkId) &#123; //ä¸šåŠ¡é€»è¾‘&#125; ç½‘ä¸Šçš„è§£å†³æ–¹æ¡ˆ æ—¢ç„¶ doRunBatchWork() æ–¹æ³•è°ƒç”¨æ²¡æœ‰è§¦å‘ AOP é€»è¾‘çš„åŸå› æ˜¯å› ä¸ºæˆ‘ä»¬ä»¥ç›®æ ‡å¯¹è±¡çš„èº«ä»½(target object) æ¥è°ƒç”¨çš„, é‚£ä¹ˆè§£å†³çš„å…³é”®è‡ªç„¶å°±æ˜¯ä»¥ä»£ç†å¯¹è±¡(proxied object)çš„èº«ä»½æ¥è°ƒç”¨ doRunBatchWork() æ–¹æ³•ã€‚ å¤‡æ³¨:ç”±äºè¿™é‡Œçš„è°ƒç”¨æ–¹æ³•æ²¡æœ‰å£°æ˜åœ¨æ¥å£ä¸­ï¼Œéœ€è¦å°†jdkåŠ¨æ€ä»£ç†è°ƒæ•´ä¸ºcglibåŠ¨æ€ä»£ç†(è¿™é‡Œå…ˆç•™ä¸ªå‘ï¼Œä»¥åå¯ä»¥æ€»ç»“ä¸‹ä¸¤è€…çš„åŒºåˆ«) è°ƒæ•´åçš„ä»£ç  12345678910111213141516171819202122232425262728//åœ¨springbootå¯åŠ¨ç±»ä¸Šæ·»åŠ ä¸‹é¢ä¸€è¡Œæ³¨è§£@EnableAspectJAutoProxy(exposeProxy=true,proxyTargetClass=true)//ä¸šåŠ¡ä¼ªä»£ç @Autowiredprivate XXServiceImpl self;/** * @param batchWorkId * @Description: æ‰¹é‡ä½œä¸šè¿è¡Œ * @Param: [batchWorkId] * @return: void * @Author: zhangjj * @Date: 2020-01-03 */@Overridepublic void runBatchWork(Long batchWorkId) &#123; //å…¶ä»–ä¸šåŠ¡ dosomething(); //è°ƒç”¨è¢«ä»£ç†çš„ä»£ç†ç±» self.doRunBatchWork(batchWorkId);&#125;@ApplyContainerRespublic void doRunBatchWork(batchWorkId) &#123; //ä¸šåŠ¡é€»è¾‘&#125; ä¿®æ”¹åï¼Œä»£ç†é€»è¾‘ç”Ÿæ•ˆã€‚ä¸è¿‡ï¼Œæ²¡è¿‡å¤šä¹…åŒäº‹åˆåé¦ˆå¦å¤–ä¸€ä¸ªé€»è¾‘è¿™ä¹ˆæ”¹é€ è¿˜æ˜¯ä¸å¥½ä½¿ï¼Œæˆ‘æŸ¥çœ‹äº†ä¸‹å‘ç°æ–¹æ³•å£°æ˜æ˜¯private(è¢«ä»£ç†çš„ç±»å¿…é¡»è¦æ˜¯publicå£°æ˜)ã€‚ä¹‹å‰æ²¡æ„è¯†åˆ°spring AOPä½¿ç”¨ä¸­ä¼šé‡åˆ°è¿™äº›é—®é¢˜ï¼Œåœ¨è¿™é‡Œä¹Ÿç®€å•æ€»ç»“ä¸‹ï¼Œæ–¹ä¾¿æŸ¥çœ‹å›å¿†ã€‚ ä½¿ç”¨æ€»ç»“ springbootä½¿ç”¨cglibä»£ç ï¼Œåœ¨å¯åŠ¨ç±»ä¸Šæ·»åŠ ä»¥ä¸‹æ³¨è§£@EnableAspectJAutoProxy(exposeProxy=true,proxyTargetClass=true) è¢«ä»£ç†çš„æ–¹æ³•å°½é‡è·¨ç±»è°ƒç”¨ è¢«ä»£ç†çš„æ–¹æ³•ä¸èƒ½å£°æ˜ä¸ºç§æœ‰æ–¹æ³•","categories":[],"tags":[{"name":"Java","slug":"Java","permalink":"https://zhangjunjunah.github.io/tags/Java/"},{"name":"Spring","slug":"Spring","permalink":"https://zhangjunjunah.github.io/tags/Spring/"}]},{"title":"è®°å½•ä¸€æ¬¡å› å†…å­˜åŸå› å¯¼è‡´k8såˆ›å»ºpodå¤±è´¥é—®é¢˜","slug":"è®°å½•ä¸€æ¬¡å› å†…å­˜åŸå› å¯¼è‡´k8såˆ›å»ºpodå¤±è´¥é—®é¢˜","date":"2020-03-23T16:00:00.000Z","updated":"2020-04-21T02:57:39.847Z","comments":true,"path":"2020/03/24/è®°å½•ä¸€æ¬¡å› å†…å­˜åŸå› å¯¼è‡´k8såˆ›å»ºpodå¤±è´¥é—®é¢˜/","link":"","permalink":"https://zhangjunjunah.github.io/2020/03/24/%E8%AE%B0%E5%BD%95%E4%B8%80%E6%AC%A1%E5%9B%A0%E5%86%85%E5%AD%98%E5%8E%9F%E5%9B%A0%E5%AF%BC%E8%87%B4k8s%E5%88%9B%E5%BB%BApod%E5%A4%B1%E8%B4%A5%E9%97%AE%E9%A2%98/","excerpt":"","text":"é—®é¢˜èƒŒæ™¯â€‹ æœ€è¿‘åŒäº‹åé¦ˆä½¿ç”¨k8såˆ›å»ºjupyterç»å¸¸åœ¨æŸä¸€å°èŠ‚ç‚¹åˆ›å»ºä¸èµ·æ¥(å…¶ä»–èŠ‚ç‚¹æ­£å¸¸)ï¼Œå¦‚æœæŠŠè¿™å°èŠ‚ç‚¹çš„dockeré‡å¯ï¼Œå½“æ—¶å¯ä»¥æ¢å¤æ­£å¸¸ï¼Œä½†è¿‡æ®µæ—¶é—´é—®é¢˜åˆä¼šå¤ç°,ä¸‹é¢é™„ä¸Škubectl describeéƒ¨åˆ†æ—¥å¿—ã€‚ 12345Events: Type Reason Age From Message---- ------ ---- ---- ------- Warning FailedCreatePodSandBox 1s (x13 over 18s) kubelet, centos7-141 Failed create pod sandbox: rpc error: code = Unknown desc = failed to start sandbox container for pod \"jupyter-lab1584951113027\": Error response from daemon: OCI runtime create failed: container_linux.go:345: starting container process caused \"process_linux.go:303: getting the final child's pid from pipe caused \\\"EOF\\\"\": unknown é—®é¢˜åˆ†æâ€‹ å¸¦ç€ç–‘é—®ä¸Šç½‘æŸ¥è¯¢æŠ¥é”™ï¼Œæœ‰çš„è¯´æ˜¯dockerç‰ˆæœ¬ã€centos å†…æ ¸ä¸k8sç‰ˆæœ¬ä¸å…¼å®¹å¯¼è‡´ï¼Ÿ â€‹ ä¾æ¬¡æŸ¥è¯¢äº†å‡ å°ä¸»æœºçš„dockerç‰ˆæœ¬(k8sæ˜¯ä¸€èµ·å®‰è£…çš„æ‰€ä»¥ç›´æ¥æ’é™¤)ï¼Œéƒ½æ˜¯19.03.5ç‰ˆæœ¬(centosç‰ˆæœ¬ä¹Ÿä¸€è‡´)ã€‚ä½†ä»”ç»†æƒ³æƒ³å…¶ä»–èŠ‚ç‚¹éƒ½æ²¡å‡ºç°è¿™ä¸ªé—®é¢˜ï¼Œå¯èƒ½é—®é¢˜åŸå› ä¸åœ¨è¿™ï¼Œæš‚æ—¶æ’é™¤ã€‚ 123456789101112131415161718192021222324252627Client: Docker Engine - Community Version: 19.03.5 API version: 1.40 Go version: go1.12.12 Git commit: 633a0ea Built: Wed Nov 13 07:25:41 2019 OS/Arch: linux/amd64 Experimental: falseServer: Docker Engine - Community Engine: Version: 19.03.5 API version: 1.40 (minimum version 1.12) Go version: go1.12.12 Git commit: 633a0ea Built: Wed Nov 13 07:24:18 2019 OS/Arch: linux/amd64 Experimental: false containerd: Version: 1.2.6 GitCommit: 894b81a4b802e4eb2a91d1ce216b8817763c29fb runc: Version: 1.0.0-rc8 GitCommit: 425e105d5a03fabd737a126ad93d62a9eeede87f docker-init: Version: 0.18.0 GitCommit: fec3683 â€‹ é—®é¢˜å›°æ‰°äº†ä¸€ä¸¤å¤©ï¼Œåæ¥çœ‹åˆ°ä¸€ç¯‡æ–‡ç« Kuberneteså› é™åˆ¶å†…å­˜é…ç½®å¼•å‘çš„é”™è¯¯ç»™æˆ‘å¯å‘ï¼Œä¼šä¸ä¼šæ˜¯å†…å­˜åŸå› å¯¼è‡´çš„é—®é¢˜ã€‚ä½¿ç”¨free å‘½ä»¤å¯¹æ¯”äº†ä¸¤å°èŠ‚ç‚¹çš„å†…å­˜ã€‚ 1234567891011# é—®é¢˜èŠ‚ç‚¹[root@centos7-141 log]# free -g total used free shared buff/cache availableMem: 22 1 0 1 20 12Swap: 0 0 0# æ­£å¸¸èŠ‚ç‚¹[root@centos7-142 ~]# free -g total used free shared buff/cache availableMem: 22 2 9 1 10 15Swap: 0 0 0 ç­‰ç­‰ï¼Œå‘ç°äº†ä¸€äº›ç«¯å€ªï¼Œä¸ºå•¥æ€»è®¡22gï¼Œåªä½¿ç”¨1g,å‰©ä½™å†…å­˜ä¸ºå•¥æ˜¯0ï¼Ÿè¿˜æœ‰buff/cache æ˜¯å•¥ï¼Ÿå¸¦ç€ç–‘é—®ï¼ŒæŸ¥è¯¢äº† buff/cache,åœ¨è¿™è®°å½•ä¸‹ã€‚ LinuxæœåŠ¡å™¨è¿è¡Œä¸€æ®µæ—¶é—´åï¼Œç”±äºå…¶å†…å­˜ç®¡ç†æœºåˆ¶ï¼Œä¼šå°†æš‚æ—¶ä¸ç”¨çš„å†…å­˜è½¬ä¸ºbuff/cacheï¼Œè¿™æ ·åœ¨ç¨‹åºä½¿ç”¨åˆ°è¿™ä¸€éƒ¨åˆ†æ•°æ®æ—¶ï¼Œèƒ½å¤Ÿå¾ˆå¿«çš„å–å‡ºï¼Œä»è€Œæé«˜ç³»ç»Ÿçš„è¿è¡Œæ•ˆç‡ï¼Œæ‰€ä»¥è¿™ä¹Ÿæ­£æ˜¯linuxå†…å­˜ç®¡ç†ä¸­éå¸¸å‡ºè‰²çš„ä¸€ç‚¹ï¼Œæ‰€ä»¥ä¹ä¸€çœ‹å†…å­˜å‰©ä½™çš„éå¸¸å°‘ï¼Œä½†æ˜¯åœ¨ç¨‹åºçœŸæ­£éœ€è¦å†…å­˜ç©ºé—´æ—¶ï¼Œlinuxä¼šå°†ç¼“å­˜è®©å‡ºç»™ç¨‹åºä½¿ç”¨ï¼Œè¿™æ ·è¾¾åˆ°å¯¹å†…å­˜çš„æœ€å……åˆ†åˆ©ç”¨ï¼Œæ‰€ä»¥çœŸæ­£å‰©ä½™çš„å†…å­˜æ˜¯free+buff/cache åœ¨è¿™é‡ŒæŒ‰ç…§å…ˆè§£å†³çš„åŸåˆ™ï¼ŒæŒ‰ç…§æ“ä½œæ­¥éª¤é‡Šæ”¾äº†buff/cacheã€‚ 123456echo 1 &gt; /proc/sys/vm/drop_caches#æ“ä½œåçš„å†…å­˜å ç”¨[root@centos7-141 log]# free -g total used free shared buff/cache availableMem: 22 1 7 1 13 12Swap: 0 0 é‡æ–°åˆ›å»ºpodï¼Œåˆ›å»ºæˆåŠŸï¼Œé—®é¢˜è§£å†³ï¼ 1234567891011Name: jupyter-lab1584951113027Namespace: kubeflowPriority: 0Node: centos7-141/192.168.128.141Start Time: Tue, 24 Mar 2020 14:00:46 +0800Labels: app=jupyterhub component=singleuser-server heritage=jupyterhubAnnotations: hub.jupyter.org/username: lab1584951113027Status: RunningIP: 10.244.3.3 åè®°â€‹ å°½ç®¡é—®é¢˜è§£å†³äº†ï¼Œä½†è¿˜æ˜¯æœ‰ä¸¤ä¸ªç–‘é—®ï¼Œåœ¨è¿™é‡Œå…ˆè®°å½•ä¸‹æ¥ buff/cacheä¸ºå•¥æ²¡æœ‰åœ¨k8séœ€è¦å†…å­˜æ—¶åŠæ—¶è®©å‡ºï¼Ÿ å¦‚æœbuff/cacheæ²¡æœ‰åŠæ—¶è®©å‡ºç¼“å­˜ï¼Œä¸ºå•¥k8s events ä¸æç¤ºå†…å­˜è¶…å‡ºé™åˆ¶æŠ¥é”™ï¼Ÿ å‚è€ƒ Kuberneteså› é™åˆ¶å†…å­˜é…ç½®å¼•å‘çš„é”™è¯¯ Linuxé‡Šæ”¾å†…å­˜ç©ºé—´","categories":[],"tags":[{"name":"Docker","slug":"Docker","permalink":"https://zhangjunjunah.github.io/tags/Docker/"},{"name":"K8S","slug":"K8S","permalink":"https://zhangjunjunah.github.io/tags/K8S/"}]},{"title":"Ceph é…ç½®RGWé«˜å¯ç”¨","slug":"ceph é…ç½® RGWé«˜å¯ç”¨","date":"2020-03-20T16:00:00.000Z","updated":"2020-04-21T02:57:39.844Z","comments":true,"path":"2020/03/21/ceph é…ç½® RGWé«˜å¯ç”¨/","link":"","permalink":"https://zhangjunjunah.github.io/2020/03/21/ceph%20%E9%85%8D%E7%BD%AE%20RGW%E9%AB%98%E5%8F%AF%E7%94%A8/","excerpt":"","text":"cephèŠ‚ç‚¹è§„åˆ’ èŠ‚ç‚¹ip èŠ‚ç‚¹ä¸»æœºå èŠ‚ç‚¹cephç»„ä»¶ å…¶ä»–ç›¸å…³ç»„ä»¶ 192.168.153.51 centos 7-ceph-1ï¼ˆceph ä¸»èŠ‚ç‚¹ï¼‰ mds1ã€mon1ã€mg1ã€rgw1ã€osd1 keepalived 192.168.153.52 centos 7-ceph-2 mon2ã€mg2ã€rgw2ã€osd2 keepalived 192.168.153.53 centos 7-ceph-3 mon3ã€mg3ã€osd3 æ•´ä½“æ¶æ„ æ–°å¢RGWæœåŠ¡ 1234567891011#åœ¨centos 7-ceph-1èŠ‚ç‚¹ä½¿ç”¨cephuserç”¨æˆ·cd my-clusterceph-deploy rgw create 128# è®¿é—®æµ‹è¯•curl -I http://centos 7-ceph-1:7480/HTTP/1.1 200 OKx-amz-request-id: tx000000000000000000001-005d0b0e2a-1018-defaultContent-Type: application/xmlContent-Length: 0Date: Thu, 20 Jun 2019 04:40:11 GMT å®‰è£…ç›¸å…³è½¯ä»¶å®‰è£…ä¾èµ–1234#åœ¨centos 7-ceph-1ã€centos 7-ceph-2èŠ‚ç‚¹ä½¿ç”¨rootç”¨æˆ·æ‰§è¡Œyum -y install openssl-devel --skip-brokenyum install -y libnl3-devel libnfnetlink-develyum -y install gcc å®‰è£…keepalived 12345678910111213141516171819#åœ¨centos 7-ceph-1ã€centos 7-ceph-2èŠ‚ç‚¹ä½¿ç”¨rootç”¨æˆ·æ‰§è¡Œcd /usr/local/src#å®˜ç½‘ä¸‹è½½keepalivedçš„æœ€æ–°ç‰ˆæœ¬ï¼Œè§£å‹å¹¶å®‰è£…wget http://www.keepalived.org/software/keepalived-2.0.7.tar.gztar xvf keepalived-2.0.7.tar.gzcd keepalived-2.0.7./configure --prefix=/usr/local/keepalivedmake &amp;&amp; make install#åˆå§‹åŒ–åŠå¯åŠ¨#keepalivedå¯åŠ¨è„šæœ¬å˜é‡å¼•ç”¨æ–‡ä»¶ï¼Œé»˜è®¤æ–‡ä»¶è·¯å¾„æ˜¯/etc/sysconfig/ï¼Œä¹Ÿå¯ä»¥ä¸åšè½¯é“¾æ¥ï¼Œç›´æ¥ä¿®æ”¹å¯åŠ¨è„šæœ¬ä¸­æ–‡ä»¶è·¯å¾„å³å¯ï¼ˆå®‰è£…ç›®å½•ä¸‹ï¼‰cp /usr/local/keepalived/etc/sysconfig/keepalived /etc/sysconfig/keepalived # å°†keepalivedä¸»ç¨‹åºåŠ å…¥åˆ°ç¯å¢ƒå˜é‡ï¼ˆå®‰è£…ç›®å½•ä¸‹ï¼‰cp /usr/local/keepalived/sbin/keepalived /usr/sbin/keepalived# keepalivedå¯åŠ¨è„šæœ¬ï¼ˆæºç ç›®å½•ä¸‹ï¼‰ï¼Œæ”¾åˆ°/etc/init.d/ç›®å½•ä¸‹å°±å¯ä»¥ä½¿ç”¨serviceå‘½ä»¤ä¾¿æ·è°ƒç”¨cp /usr/local/src/keepalived-2.0.7/keepalived/etc/init.d/keepalived /etc/init.d/keepalived # å°†é…ç½®æ–‡ä»¶æ”¾åˆ°é»˜è®¤è·¯å¾„ä¸‹mkdir /etc/keepalivedcp /usr/local/keepalived/etc/keepalived/keepalived.conf etc/keepalived/keepalived.conf keepalived.confé…ç½®12345678910111213141516171819202122232425262728293031#centos 7-ceph-1èŠ‚ç‚¹cp /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bakcat /etc/keepalived/keepalived.conf! Configuration File for keepalivedglobal_defs &#123;&#125;vrrp_script chk_rgw &#123; script \"/usr/local/keepalived/sbin/check_rgw.sh\" # è¯¥è„šæœ¬æ£€æµ‹rgwçš„è¿è¡ŒçŠ¶æ€ï¼Œå¹¶åœ¨rgwè¿›ç¨‹æŒ‚äº†ä¹‹åå°è¯•é‡æ–°å¯åŠ¨rgwï¼Œå¦‚æœå¯åŠ¨å¤±è´¥åˆ™åœæ­¢keepalivedï¼Œå‡†å¤‡è®©å…¶å®ƒæœºå™¨æ¥ç®¡ã€‚ interval 2 # æ¯2sæ£€æµ‹ä¸€æ¬¡ weight 2 # æ£€æµ‹å¤±è´¥ï¼ˆè„šæœ¬è¿”å›é0ï¼‰åˆ™ä¼˜å…ˆçº§2&#125;vrrp_instance VI_1 &#123; state MASTER # æŒ‡å®škeepalivedçš„è§’è‰²ï¼ŒMASTERè¡¨ç¤ºæ­¤ä¸»æœºæ˜¯ä¸»æœåŠ¡å™¨ï¼ŒBACKUPè¡¨ç¤ºæ­¤ä¸»æœºæ˜¯å¤‡ç”¨æœåŠ¡å™¨ interface ens32 # æŒ‡å®šHAç›‘æµ‹ç½‘ç»œçš„æ¥å£ æ ¹æ®ä½ å®é™…çš„ç½‘å¡åæ¥ keyong ip addr æŸ¥è¯¢ virtual_router_id 51 # è™šæ‹Ÿè·¯ç”±æ ‡è¯†ï¼Œè¿™ä¸ªæ ‡è¯†æ˜¯ä¸€ä¸ªæ•°å­—ï¼ŒåŒä¸€ä¸ªvrrpå®ä¾‹ä½¿ç”¨å”¯ä¸€çš„æ ‡è¯†ã€‚å³åŒä¸€vrrp_instanceä¸‹ï¼ŒMASTERå’ŒBACKUPå¿…é¡»æ˜¯ä¸€è‡´çš„ priority 100 # å®šä¹‰ä¼˜å…ˆçº§ï¼Œæ•°å­—è¶Šå¤§ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼Œåœ¨åŒä¸€ä¸ªvrrp_instanceä¸‹ï¼ŒMASTERçš„ä¼˜å…ˆçº§å¿…é¡»å¤§äºBACKUPçš„ä¼˜å…ˆçº§ advert_int 1 # è®¾å®šMASTERä¸BACKUPè´Ÿè½½å‡è¡¡å™¨ä¹‹é—´åŒæ­¥æ£€æŸ¥çš„æ—¶é—´é—´éš”ï¼Œå•ä½æ˜¯ç§’ authentication &#123; auth_type PASS # è®¾ç½®éªŒè¯ç±»å‹ï¼Œä¸»è¦æœ‰PASSå’ŒAHä¸¤ç§ auth_pass 1111 # è®¾ç½®éªŒè¯å¯†ç ï¼Œåœ¨åŒä¸€ä¸ªvrrp_instanceä¸‹ï¼ŒMASTERä¸BACKUPå¿…é¡»ä½¿ç”¨ç›¸åŒçš„å¯†ç æ‰èƒ½æ­£å¸¸é€šä¿¡ &#125; virtual_ipaddress &#123; 192.168.153.16 # è®¾ç½®è™šæ‹ŸIPåœ°å€(ä¸èŠ‚ç‚¹ipåŒç½‘æ®µ) &#125; track_script &#123; chk_rgw # å¼•ç”¨VRRPè„šæœ¬ï¼Œå³åœ¨ vrrp_script éƒ¨åˆ†æŒ‡å®šçš„åå­—ã€‚å®šæœŸè¿è¡Œå®ƒä»¬æ¥æ”¹å˜ä¼˜å…ˆçº§ï¼Œå¹¶æœ€ç»ˆå¼•å‘ä¸»å¤‡åˆ‡æ¢ã€‚ &#125;&#125; 12345678910111213141516171819202122232425262728293031#centos 7-ceph-2èŠ‚ç‚¹cp /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bakcat /etc/keepalived/keepalived.conf! Configuration File for keepalivedglobal_defs &#123;&#125;vrrp_script chk_rgw &#123; script \"/usr/local/keepalived/sbin/check_rgw.sh\" # è¯¥è„šæœ¬æ£€æµ‹rgwçš„è¿è¡ŒçŠ¶æ€ï¼Œå¹¶åœ¨rgwè¿›ç¨‹æŒ‚äº†ä¹‹åå°è¯•é‡æ–°å¯åŠ¨rgwï¼Œå¦‚æœå¯åŠ¨å¤±è´¥åˆ™åœæ­¢keepalivedï¼Œå‡†å¤‡è®©å…¶å®ƒæœºå™¨æ¥ç®¡ã€‚ interval 2 # æ¯2sæ£€æµ‹ä¸€æ¬¡ weight 2 # æ£€æµ‹å¤±è´¥ï¼ˆè„šæœ¬è¿”å›é0ï¼‰åˆ™ä¼˜å…ˆçº§2&#125;vrrp_instance VI_1 &#123; state BACKUP # æŒ‡å®škeepalivedçš„è§’è‰²ï¼ŒMASTERè¡¨ç¤ºæ­¤ä¸»æœºæ˜¯ä¸»æœåŠ¡å™¨ï¼ŒBACKUPè¡¨ç¤ºæ­¤ä¸»æœºæ˜¯å¤‡ç”¨æœåŠ¡å™¨ interface ens32 # æŒ‡å®šHAç›‘æµ‹ç½‘ç»œçš„æ¥å£ æ ¹æ®ä½ å®é™…çš„ç½‘å¡åæ¥ keyong ip addr æŸ¥è¯¢ virtual_router_id 51 # è™šæ‹Ÿè·¯ç”±æ ‡è¯†ï¼Œè¿™ä¸ªæ ‡è¯†æ˜¯ä¸€ä¸ªæ•°å­—ï¼ŒåŒä¸€ä¸ªvrrpå®ä¾‹ä½¿ç”¨å”¯ä¸€çš„æ ‡è¯†ã€‚å³åŒä¸€vrrp_instanceä¸‹ï¼ŒMASTERå’ŒBACKUPå¿…é¡»æ˜¯ä¸€è‡´çš„ priority 100 # å®šä¹‰ä¼˜å…ˆçº§ï¼Œæ•°å­—è¶Šå¤§ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼Œåœ¨åŒä¸€ä¸ªvrrp_instanceä¸‹ï¼ŒMASTERçš„ä¼˜å…ˆçº§å¿…é¡»å¤§äºBACKUPçš„ä¼˜å…ˆçº§ advert_int 1 # è®¾å®šMASTERä¸BACKUPè´Ÿè½½å‡è¡¡å™¨ä¹‹é—´åŒæ­¥æ£€æŸ¥çš„æ—¶é—´é—´éš”ï¼Œå•ä½æ˜¯ç§’ authentication &#123; auth_type PASS # è®¾ç½®éªŒè¯ç±»å‹ï¼Œä¸»è¦æœ‰PASSå’ŒAHä¸¤ç§ auth_pass 1111 # è®¾ç½®éªŒè¯å¯†ç ï¼Œåœ¨åŒä¸€ä¸ªvrrp_instanceä¸‹ï¼ŒMASTERä¸BACKUPå¿…é¡»ä½¿ç”¨ç›¸åŒçš„å¯†ç æ‰èƒ½æ­£å¸¸é€šä¿¡ &#125; virtual_ipaddress &#123; 192.168.153.16 # è®¾ç½®è™šæ‹ŸIPåœ°å€(ä¸èŠ‚ç‚¹ipåŒç½‘æ®µ) &#125; track_script &#123; chk_rgw # å¼•ç”¨VRRPè„šæœ¬ï¼Œå³åœ¨ vrrp_script éƒ¨åˆ†æŒ‡å®šçš„åå­—ã€‚å®šæœŸè¿è¡Œå®ƒä»¬æ¥æ”¹å˜ä¼˜å…ˆçº§ï¼Œå¹¶æœ€ç»ˆå¼•å‘ä¸»å¤‡åˆ‡æ¢ã€‚ &#125;&#125; centos 7-ceph-1/2 ä¸­ï¼Œ/usr/local/keepalived/sbin/check_rgw.shè„šæœ¬å†…å®¹å¦‚ä¸‹ 1234567891011#!/bin/bashif [ \"$(ps -ef | grep \"radosgw\"| grep -v grep )\" == \"\" ];then systemctl start ceph-radosgw.target sleep 3 if [ \"$(ps -ef | grep \"radosgw\"| grep -v grep )\" == \"\" ];then systemctl stop keepalived fifi#æ·»åŠ check_rgw.shè„šæœ¬æ‰§è¡Œæƒé™chmod +x /usr/local/keepalived/sbin/check_rgw.sh åˆ°è¿™é‡Œå¯¹keepalivedçš„é…ç½®å·²ç»å®Œæˆï¼Œç„¶ååˆ†åˆ«å¯åŠ¨centos 7-ceph-1/2ç‚¹ä¸Šçš„keepalived 1systemctl start keepalived åˆ†åˆ«åœ¨centos 7-ceph-1å’Œcentos 7-ceph-2èŠ‚ç‚¹ä¸Šæ‰§è¡Œip aå‘½ä»¤ï¼ŒæŸ¥çœ‹è™šIPä¿¡æ¯ï¼š 1234567891011121314151617181920212223242526272829#centos 7-ceph-11: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 inet 127.0.0.1/8 scope host lo valid_lft forever preferred_lft forever inet6 ::1/128 scope host valid_lft forever preferred_lft forever2: ens32: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 link/ether 00:0c:29:67:df:45 brd ff:ff:ff:ff:ff:ff inet 192.168.153.51/24 brd 192.168.129.255 scope global noprefixroute ens32 valid_lft forever preferred_lft forever inet 192.168.153.16/32 scope global ens32 valid_lft forever preferred_lft forever inet6 fe80::388c:a9c2:c50b:dd48/64 scope link noprefixroute valid_lft forever preferred_lft forever#centos 7-ceph-21: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 inet 127.0.0.1/8 scope host lo valid_lft forever preferred_lft forever inet6 ::1/128 scope host valid_lft forever preferred_lft forever2: ens32: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 link/ether 00:0c:29:4c:7f:2a brd ff:ff:ff:ff:ff:ff inet 192.168.153.52/24 brd 192.168.129.255 scope global noprefixroute ens32 valid_lft forever preferred_lft forever inet6 fe80::58cc:e799:bc61:7fd5/64 scope link noprefixroute valid_lft forever preferred_lft forever è°ƒæ•´S3é…ç½®1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556[cephuser@centos 7-ceph-1 keepalived-2.0.7]$ s3cmd --configureEnter new values or accept defaults in brackets with Enter.Refer to user manual for detailed description of all options.Access key and Secret key are your identifiers for Amazon S3. Leave them empty for using the env variables.Access Key [AY96HNDL9H2QV2SRPNDJ]: Secret Key [Q8OhUOJdRJg8KzAUwZ22BddL7QbC6g8hHCGwq1jx]: Default Region [US]: Use \"s3.amazonaws.com\" for S3 Endpoint and not modify it to the target Amazon S3.S3 Endpoint [192.168.153.51:7480]: 192.168.153.16:7480Use \"%(bucket)s.s3.amazonaws.com\" to the target Amazon S3. \"%(bucket)s\" and \"%(location)s\" vars can be usedif the target S3 system supports dns based buckets.DNS-style bucket+hostname:port template for accessing a bucket [192.168.153.51:7480]: 192.168.153.16:7480Encryption password is used to protect your files from readingby unauthorized persons while in transfer to S3Encryption password: Path to GPG program [/bin/gpg]: When using secure HTTPS protocol all communication with Amazon S3servers is protected from 3rd party eavesdropping. This method isslower than plain HTTP, and can only be proxied with Python 2.7 or newerUse HTTPS protocol [No]: On some networks all internet access must go through a HTTP proxy.Try setting it here if you can't connect to S3 directlyHTTP Proxy server name: New settings: Access Key: AY96HNDL9H2QV2SRPNDJ Secret Key: Q8OhUOJdRJg8KzAUwZ22BddL7QbC6g8hHCGwq1jx Default Region: US S3 Endpoint: 192.168.153.16:7480 DNS-style bucket+hostname:port template for accessing a bucket: 192.168.153.16:7480 Encryption password: Path to GPG program: /bin/gpg Use HTTPS protocol: False HTTP Proxy server name: HTTP Proxy server port: 0Test access with supplied credentials? [Y/n] yPlease wait, attempting to list all buckets...Success. Your access key and secret key worked fine :-)Now verifying that encryption works...Not configured. Never mind.Save settings? [y/N] yConfiguration saved to '/home/cephuser/.s3cfg'[cephuser@centos 7-ceph-1 keepalived-2.0.7]$ s3cmd ls2020-03-11 07:16 s3://MyBucket_12020-03-11 07:45 s3://algorithm-bucket2020-03-11 07:44 s3://demo-bucket å‚è€ƒå¼•ç”¨keepalivedé…ç½®RGWé«˜å¯ç”¨","categories":[],"tags":[{"name":"Ceph","slug":"Ceph","permalink":"https://zhangjunjunah.github.io/tags/Ceph/"},{"name":"Linux","slug":"Linux","permalink":"https://zhangjunjunah.github.io/tags/Linux/"}]},{"title":"Cephå’Œs3çš„å®‰è£…","slug":"cephå’Œs3çš„å®‰è£…","date":"2020-03-20T16:00:00.000Z","updated":"2020-04-21T02:57:39.845Z","comments":true,"path":"2020/03/21/cephå’Œs3çš„å®‰è£…/","link":"","permalink":"https://zhangjunjunah.github.io/2020/03/21/ceph%E5%92%8Cs3%E7%9A%84%E5%AE%89%E8%A3%85/","excerpt":"","text":"éƒ¨ç½²è¯´æ˜ å®‰è£…çš„cephç‰ˆæœ¬ï¼ˆ14.2.4ï¼‰ã€s3 ç‰ˆæœ¬(2.0.2) cephä½¿ç”¨ceph-deployéƒ¨ç½²é«˜å¯ç”¨é›†ç¾¤è‡³å°‘éœ€è¦3å°èŠ‚ç‚¹(ceph ç›‘è§†å™¨éœ€è¦3ä¸ªä»¥ä¸ŠèŠ‚ç‚¹) cephæ¨èä½¿ç”¨è£¸ç›˜å®‰è£…osd(æ–‡ä»¶å¤¹ä¹Ÿå¯ä»¥éƒ¨ç½²ï¼Œä½†ä¸æ¨è) cephéƒ¨ç½²èŠ‚ç‚¹è§„åˆ’ èŠ‚ç‚¹ip èŠ‚ç‚¹ä¸»æœºå èŠ‚ç‚¹cephç»„ä»¶ 192.168.153.51 centos 7-ceph-1ï¼ˆceph ä¸»èŠ‚ç‚¹ï¼‰ mds1ã€mon1ã€mg1ã€rgwã€osd1 192.168.153.52 centos 7-ceph-2 mon2ã€mg2ã€osd2ã€ 192.168.153.53 centos 7-ceph-3 mon3ã€mg3ã€osd3 åˆ›å»ºéƒ¨ç½²ç”¨æˆ·æ³¨æ„ï¼Œåœ¨å¤–ç½‘ç¯å¢ƒï¼Œç¦æ­¢ä½¿ç”¨ ceph æœåŠ¡å ä½œä¸ºç”¨æˆ·ï¼Œé˜²æ­¢æš´åŠ›ç ´è§£ã€‚ å› ä¸º ceph-deploy éƒ¨ç½²å·¥å…·éœ€è¦ä»¥ç™»å½•ç”¨æˆ·ï¼ˆä¸”åŒ…å«sudoæƒé™ï¼‰æ¥å®‰è£…è½¯ä»¶å’Œåšé…ç½®ï¼Œå› æ­¤é€šå¸¸åœ¨ä¸»èŠ‚ç‚¹åˆ›å»º ceph ç”¨æˆ·ã€‚ 12345678910111213141516171819# åœ¨æ¯ä¸€ä¸ªèŠ‚ç‚¹æ‰§è¡Œï¼ˆcentos 7-ceph-1ã€centos 7-ceph-2ã€centos 7-ceph-3ï¼‰useradd cephuserecho 'cephuser' | passwd --stdin cephuserecho \"cephuser ALL = (root) NOPASSWD:ALL\" &gt; /etc/sudoers.d/cephuserchmod 0440 /etc/sudoers.d/cephuser# é…ç½®sshdå¯ä»¥ä½¿ç”¨passwordç™»å½•sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_configsystemctl reload sshd# é…ç½®sudoä¸éœ€è¦ttysed -i 's/Default requiretty/#Default requiretty/' /etc/sudoers#æ¯ä¸ªèŠ‚ç‚¹æ·»åŠ hosts192.168.153.51 centos 7-ceph-1192.168.153.52 centos 7-ceph-2192.168.153.53 centos 7-ceph-3# è®¾ç½®å…å¯†ç™»å½•ï¼ˆä½¿ç”¨cephuserç”¨æˆ·ï¼‰ssh-keygen -t rsa # åœ¨centos 7-ceph-1ä½¿ç”¨cephuserç”¨æˆ·æ“ä½œssh-copy-id -i /home/cephuser/.ssh/id_rsa.pub cephuser@centos 7-ceph-2ssh-copy-id -i /home/cephuser/.ssh/id_rsa.pub cephuser@centos 7-ceph-3 åˆ›å»ºè™šæ‹Ÿå·é€šè¿‡è™šæ‹Ÿæœºç®¡ç†ç•Œé¢åˆ†åˆ«ä¸ºæ¯ä¸ªèŠ‚ç‚¹ æŒ‚è½½æ–°ç£ç›˜ 12345# æ¯å°èŠ‚ç‚¹æ“ä½œ(root)fdisk -l #æŸ¥çœ‹æŒ‚è½½çš„ç£ç›˜åï¼Œ#æ ¼å¼åŒ–ç£ç›˜parted -s /dev/sdb mklabel gpt mkpart primary xfs 0% 100%mkfs.xfs /dev/sdb -f å…³é—­ SetLinuxï¼ˆå»ºè®®ï¼‰ 12345# å»ºè®®æ‰§è¡Œï¼Œæ³¨æ„éœ€è¦é‡å¯æœºå™¨setenforce 0 sed -i \"s/SELINUX=enforcing/SELINUX=disabled /g\" /etc/selinux/config # é‡å¯æœºå™¨ï¼Œæ£€æŸ¥ï¼Œå¦‚æœSELinux statuså‚æ•°ä¸ºdisabledå³ä¸ºå…³é—­çŠ¶æ€/usr/sbin/sestatus -v å…³é—­é˜²ç«å¢™ 123# å¯é€‰ï¼Œå¦‚æœä¸å…³é—­éœ€è¦å¼€å¯å¯¹åº”ç«¯å£ï¼Œæœ¬ä¾‹ç®€å•çš„å…³é—­å¤„ç†systemctl disable firewalld.service systemctl stop firewalld.service é…ç½®ntpæœåŠ¡å™¨ 12345678910111213141516# åœ¨ä¸‰å°èŠ‚ç‚¹rootæ‰§è¡Œï¼ˆcentos 7-ceph-1ã€centos 7-ceph-2ã€centos 7-ceph-3ï¼‰yum -y install ntp# å°†centos 7-ceph-1é…ç½®æˆntpæœåŠ¡ç«¯[root@centos7-ceph-1 ~]# cat /etc/ntp.confserver 127.127.1.0fudge 127.127.1.0 stratum 10restrict 192.168.153.1 mask 255.255.255.0 nomodify notrap#å¯åŠ¨ntpsystemctl start ntpd &amp;&amp; systemctl enable ntpd# centos 7-ceph-2ã€centos 7-ceph-3é…ç½®ntpå®¢æˆ·ç«¯cat /etc/ntp.conf server 192.168.153.51#æ‰§è¡Œæ‰‹åŠ¨åŒæ­¥ntpdate 192.168.153.51systemctl start ntpd &amp;&amp; systemctl enable ntpd å¼€å§‹éƒ¨ç½²å®‰è£… ceph ä¾èµ– 12345# ceph-deploy æ˜¯ceph çš„éƒ¨ç½²å·¥å…·ï¼Œåœ¨ç®¡ç†èŠ‚ç‚¹(centos 7-ceph-1æ‰§è¡Œ)yum install -y ceph-deploy ceph-deploy --version // 2.0.1# å®‰è£… ceph å’Œ radosgw ,åœ¨æ¯å°èŠ‚ç‚¹æ‰§è¡Œï¼ˆcentos 7-ceph-1ã€centos 7-ceph-2ã€centos 7-ceph-3ï¼‰yum install -y ceph ceph-radosgw æ­å»º ceph æœåŠ¡ 12345678910111213141516171819202122232425262728293031323334# æ³¨æ„ä»¥ä¸‹æ‰€æœ‰ä½¿ç”¨ ceph ç”¨æˆ·æ‰§è¡Œï¼Œä¸è¦ä½¿ç”¨ sudo ï¼Œä¸è¦ä½¿ç”¨rootsu - cephusermkdir my-clustercd my-cluster# åˆ›å»ºé›†ç¾¤ï¼Œç”¨ new å‘½ä»¤ï¼Œå¹¶æŒ‡å®šå‡ ä¸ªä¸»æœºå®‰è£…åˆå§‹ceph Monitor æœåŠ¡# åœ¨centos 7-ceph-1ä¸Šæ“ä½œceph-deploy new centos 7-ceph-1# æ­¤æ—¶ä¼šåœ¨å½“å‰ç›®å½•ç”Ÿæˆ ceph é…ç½®æ–‡ä»¶ã€æ—¥å¿—å’Œå¯†é’¥æ–‡ä»¶# æ³¨æ„å®é™…ç”Ÿæ•ˆçš„é…ç½®æ–‡ä»¶å°†åœ¨ /etc/ceph/ceph.conf ï¼ˆå½“å‰è¿˜æœªç”Ÿç”Ÿæˆï¼‰ï¼Œæœ€ä½³å®è·µä¸ºä¿®æ”¹ $HOME ç›®å½•ä¸‹çš„æ–‡ä»¶é…ç½®ï¼Œé€šè¿‡ deploy å·¥å…·åˆ†å‘åˆ°å„èŠ‚ç‚¹lsceph.conf ceph-deploy-ceph.log ceph.mon.keyring# éœ€è¦ä¿®æ”¹ä¸€ä¸‹é…ç½®æ–‡ä»¶echo \"public network = 192.168.153.0/24\" &gt;&gt; ceph.confecho \"cluster network = 192.168.153.0/24\" &gt;&gt; ceph.confecho \"osd pool default size = 3\" &gt;&gt; ceph.confecho \"osd pool default min size = 2\" &gt;&gt; ceph.confecho \"mon_max_pg_per_osd = 650\" &gt;&gt; ceph.confecho \"[osd]\" &gt;&gt; ceph.confecho \"mon_osd_backfillfull_ratio=0.7\" &gt;&gt; ceph.confecho \"mon_osd_full_ratio=0.8\" &gt;&gt; ceph.confecho \"mon_osd_nearfull_ratio=0.6\" &gt;&gt; ceph.confecho \"osd_failsafe_full_ratio=0.8\" &gt;&gt; ceph.conf# éƒ¨ç½²monitorå’Œç”Ÿæˆkeysceph-deploy mon create-initialls -l *.keyring# å¤åˆ¶æ–‡ä»¶åˆ°nodeèŠ‚ç‚¹ceph-deploy --overwrite-conf admin centos 7-ceph-1 centos 7-ceph-2 centos 7-ceph-3# éƒ¨ç½²manager ï¼ˆluminous+ï¼‰12åŠä»¥åçš„ç‰ˆæœ¬éœ€è¦éƒ¨ç½²ceph-deploy mgr create centos 7-ceph-1 åˆ›å»º OSDï¼ˆå¯¹è±¡å­˜å‚¨åå°è¿›ç¨‹ï¼‰ 1234567891011#åœ¨centos 7-ceph-1ç”¨cephuserç”¨æˆ·æ‰§è¡Œceph-deploy osd create --data /dev/sdb centos 7-ceph-1 ceph-deploy osd create --data /dev/sdb centos 7-ceph-2 ceph-deploy osd create --data /dev/sdb centos 7-ceph-3 # æŸ¥çœ‹ osd treeå’Œcephé›†ç¾¤çŠ¶æ€sudo ceph osd treesudo ceph -ssudo ceph health detail //HEALTH_OK# è‡³æ­¤ åŸºæœ¬cephå®‰è£…å®Œæ¯• é«˜å¯ç”¨é…ç½®(monã€mgr) 123456789# æ·»åŠ monitorceph-deploy mon add centos 7-ceph-2ceph-deploy mon add centos 7-ceph-3# æ·»åŠ managerceph-deploy mgr create centos 7-ceph-2 centos 7-ceph-3# å¸è½½monitorceph-deploy mon destroy centos 7-ceph-2 éƒ¨ç½²RGWCephéƒ¨ç½²RGWä»¥å…¼å®¹S3/Swiftæ¥å£ï¼Œå³å¯ä»¥ä½¿ç”¨S3æˆ–Swiftçš„å‘½ä»¤è¡Œå·¥å…·æˆ–SDKæ¥ä½¿ç”¨cephã€‚ éƒ¨ç½²RGWç½‘å…³ 12345678910111213141516171819202122232425# å¯åŠ¨ RGWï¼Œæ³¨æ„å¼€æ”¾çš„ç½‘å…³ç«¯å£ï¼Œé»˜è®¤7480ceph-deploy rgw create centos 7-ceph-1 // The Ceph Object Gateway (RGW) is now running on host centos 7-ceph-1 and default port 7480# è®¿é—®æµ‹è¯•curl -I http://centos 7-ceph-1:7480/HTTP/1.1 200 OKx-amz-request-id: tx000000000000000000001-005d0b0e2a-1018-defaultContent-Type: application/xmlContent-Length: 0Date: Thu, 20 Jun 2019 04:40:11 GMT# é¡µé¢è®¿é—®æµ‹è¯• # è‡³æ­¤ Ceph ç«¯å¯¹è±¡è®¿é—®æ¥å£å·²ç»éƒ¨ç½²å®Œæˆï¼Œå¯ä½¿ç”¨s3 å·¥å…·è®¿é—® # é™„å…¶ä»–æ“ä½œ # é™„1ï¼šæ›´æ”¹å¼€æ”¾ç«¯å£ï¼Œéœ€é‡å¯RGW# ä¿®æ”¹é…ç½® /etc/ceph/ceph.confï¼Œä½¿ç”¨ rgw ç›‘å¬åœ¨ 80 ç«¯å£ [client.rgw.lab1]rgw_frontends = \"civetweb port=80\" # é™„2ï¼šé‡å¯ RGWsystemctl restart ceph-radosgw@rgw.k8s113 å¯¹è±¡å­˜å‚¨æœåŠ¡ä¸æµ‹è¯•ï¼ˆS3/Swiftï¼‰ç¦»çº¿å®‰è£… s3cmd 12345rpm -ivh python-dateutil-1.5-7.el7.noarch.rpm python-magic-5.11-35.el7.noarch.rpm s3cmd-2.0.2-1.el7.noarch.rpms3cmd --versions3cmd version 2.0.2 å¯¹è±¡å­˜å‚¨æµ‹è¯•ï¼ˆä½¿ç”¨s3cmdæµ‹è¯•ï¼‰ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141# æµ‹è¯•# åˆ›å»ºS3æ‰€éœ€è¦çš„poolsudo ceph osd pool create .rgw 128 128sudo ceph osd pool create .rgw.root 128 128sudo ceph osd pool create .rgw.control 128 128sudo ceph osd pool create .rgw.gc 128 128sudo ceph osd pool create .rgw.buckets 128 128sudo ceph osd pool create .rgw.buckets.index 128 128sudo ceph osd pool create .rgw.buckets.extra 128 128sudo ceph osd pool create .log 128 128sudo ceph osd pool create .intent-log 128 128sudo ceph osd pool create .usage 128 128sudo ceph osd pool create .users 128 128sudo ceph osd pool create .users.email 128 128sudo ceph osd pool create .users.swift 128 128sudo ceph osd pool create .users.uid 128 128# æŸ¥çœ‹rados lspools# è®¿é—®æµ‹è¯•curl -I http://192.168.153.51:7480/# åˆ›å»ºS3ç”¨æˆ·# æ³¨æ„ï¼šä¿å­˜å‘½ä»¤è¿”å›çš„ user access_key secret_keysudo radosgw-admin user create --uid=s3_user --display-name=s3_user --email=s3@s3.com\"access_key\": \"FZ95GV7T0WU8OVOL4YH9\",\"secret_key\": \"WFgeHmpjywZ3AAWDjc3atNOsGAP7gJkNmUVWHoPK\"# åˆ›å»ºadminç”¨æˆ·radosgw-admin user create --uid=admin --display-name=admin\"access_key\": \"B3M00AHVE9FEXCQ8D0L9\",\"secret_key\": \"JVJG1O4LDGam35EBghXGsgrdOwhqGzVKPtR6ntw4\"# å…è®¸adminè¯»å†™æ‰€æœ‰usersä¿¡æ¯radosgw-admin caps add --uid=admin --caps=\"users=*\"# å…è®¸adminè¯»å†™æ‰€æœ‰çš„usageä¿¡æ¯radosgw-admin caps add --uid=admin --caps=\"usage=read,write\"# é…ç½®s3cmdï¼ˆå½“å‰åœ¨ cephç›®å½•ä¸‹ï¼Œé™„å®Œæ•´è¿‡ç¨‹ï¼Œè¾“å…¥ä¹‹å‰åˆ›å»ºçš„ s3_user_tydic ç”¨æˆ·å¯†é’¥ï¼‰ s3cmd --configureEnter new values or accept defaults in brackets with Enter.Refer to user manual for detailed description of all options.Access key and Secret key are your identifiers for Amazon S3. Leave them empty for using the env variables.Access Key: FZ95GV7T0WU8OVOL4YH9Secret Key: WFgeHmpjywZ3AAWDjc3atNOsGAP7gJkNmUVWHoPKDefault Region [US]:Use \"s3.amazonaws.com\" for S3 Endpoint and not modify it to the target Amazon S3.S3 Endpoint [s3.amazonaws.com]: 192.168.153.51:7480 //æ³¨æ„ï¼šæ­¤å¤„å¿…é¡»ä½¿ç”¨ ip:port å½¢å¼ï¼Œä½¿ç”¨åŸŸåæ–¹å¼å°†ä¼šå¯¼è‡´ä»s3cmdåˆ›å»ºçš„æ¡¶å¿…é¡»æ˜¯ä»¥å¤§å†™å­—æ¯å¼€å¤´ï¼Œæ­¤å‘½åä¸äºšé©¬é€Šå®˜æ–¹æ¡¶å‘½åè¦æ±‚ç›¸æ‚–ï¼Œå»ºè®®ä¿®æ”¹ä¸ºip:port æ–¹å¼ã€‚Use \"%(bucket)s.s3.amazonaws.com\" to the target Amazon S3. \"%(bucket)s\" and \"%(location)s\" vars can be usedif the target S3 system supports dns based buckets.DNS-style bucket+hostname:port template for accessing a bucket [%(bucket)s.s3.amazonaws.com]: 192.168.153.51:7480 //ip:port å½¢å¼Encryption password is used to protect your files from readingby unauthorized persons while in transfer to S3Encryption password: //ç©ºPath to GPG program [/bin/gpg]: //ç©ºWhen using secure HTTPS protocol all communication with Amazon S3servers is protected from 3rd party eavesdropping. This method isslower than plain HTTP, and can only be proxied with Python 2.7 or newerUse HTTPS protocol [Yes]: noOn some networks all internet access must go through a HTTP proxy.Try setting it here if you can't connect to S3 directlyHTTP Proxy server name: //ç©ºTest access with supplied credentials? [Y/n] yPlease wait, attempting to list all buckets...Success. Your access key and secret key worked fine :-)Now verifying that encryption works...Not configured. Never mind.Save settings? [y/N] yConfiguration saved to '/home/ceph/.s3cfg'# æ³¨æ„ s3 é…ç½®æ–‡ä»¶ç”Ÿæˆä½ç½®ä¿®è¯¥ç”Ÿæˆçš„é…ç½®æ–‡ä»¶ï¼Œåç»­å¯åšè‡ªå®šä¹‰ä¿®æ”¹# é‡ç‚¹é…ç½®é¡¹ç¤ºä¾‹ï¼Œå…¶ä»–é¡¹å‡ä¸ºé»˜è®¤é¡¹[default]access_key = FZ95GV7T0WU8OVOL4YH9secret_key = WFgeHmpjywZ3AAWDjc3atNOsGAP7gJkNmUVWHoPKhost_base = 192.168.153.51:7480host_bucket = 192.168.153.51:7480use_https = False# åˆ›å»ºBucketï¼ˆæ³¨æ„å‘½ä»¤è¡Œç«¯bucketé¦–å­—æ¯å¿…é¡»å¤§å†™ï¼‰s3cmd mb s3://MyBucket_1s3cmd ls# ä¸Šä¼ Objectecho 'hello ceph block storage s3' &gt; hello.txts3cmd put hello.txt s3://MyBucket_1# æŸ¥çœ‹Objects3cmd ls s3://MyBucket_1# ä¸‹è½½Objectcd /tmps3cmd get s3://mybucket/hello.txtcat hello.txt# åˆ é™¤bucketä¸‹æ‰€æœ‰å¯¹è±¡s3cmd del -rf s3://MyBucket_1 s3cmd ls -r s3://MyBucket_1# åˆ é™¤Buckets3cmd mb s3://MyBucket_1s3cmd rb s3://MyBucket_1# å…¶ä»–æ“ä½œ# åˆ é™¤S3ç”¨æˆ·radosgw-admin user rm --uid=s3_user_tydicradosgw-admin user rm --uid=admin#è°ƒæ•´poolå‰¯æœ¬æ•°ceph osd pool set default.rgw.buckets.data size 3ceph osd pool set default.rgw.buckets.data min_size 2# åˆ é™¤poolceph osd pool delete .rgw .rgw --yes-i-really-really-mean-itceph osd pool delete .rgw.root .rgw.root --yes-i-really-really-mean-itceph osd pool delete .rgw.control .rgw.control --yes-i-really-really-mean-itceph osd pool delete .rgw.gc .rgw.gc --yes-i-really-really-mean-itceph osd pool delete .rgw.buckets .rgw.buckets --yes-i-really-really-mean-itceph osd pool delete .rgw.buckets.index .rgw.buckets.index --yes-i-really-really-mean-itceph osd pool delete .rgw.buckets.extra .rgw.buckets.extra --yes-i-really-really-mean-itceph osd pool delete .log .log --yes-i-really-really-mean-itceph osd pool delete .intent-log .intent-log --yes-i-really-really-mean-itceph osd pool delete .usage .usage --yes-i-really-really-mean-itceph osd pool delete .users .users --yes-i-really-really-mean-itceph osd pool delete .users.email .users.email --yes-i-really-really-mean-itceph osd pool delete .users.swift .users.swift --yes-i-really-really-mean-itceph osd pool delete .users.uid .users.uid --yes-i-really-really-mean-it Ceph DashboardCeph Dashboardä»‹ç»Ceph çš„ç›‘æ§å¯è§†åŒ–ç•Œé¢æ–¹æ¡ˆå¾ˆå¤šâ€”-grafanaã€Krakenã€‚ä½†æ˜¯ä»Luminouså¼€å§‹ï¼ŒCeph æä¾›äº†åŸç”Ÿçš„DashboardåŠŸèƒ½ï¼Œé€šè¿‡Dashboardå¯ä»¥è·å–Cephé›†ç¾¤çš„å„ç§åŸºæœ¬çŠ¶æ€ä¿¡æ¯ã€‚ é…ç½®Ceph Dashboardå®‰è£…å’Œé…ç½®12345678910111213141516171819202122# 1ã€åœ¨æ¯ä¸ªmgrèŠ‚ç‚¹å®‰è£… yum install ceph-mgr-dashboard # 2ã€å¼€å¯mgråŠŸèƒ½ ceph mgr module enable dashboard # 3ã€ç”Ÿæˆå¹¶å®‰è£…è‡ªç­¾åçš„è¯ä¹¦ ceph dashboard create-self-signed-cert # 4ã€åˆ›å»ºä¸€ä¸ªdashboardç™»å½•ç”¨æˆ·åå¯†ç  ceph dashboard ac-user-create super 123456 administrator # 5ã€æŸ¥çœ‹æœåŠ¡è®¿é—®æ–¹å¼ ceph mgr services&#123; \"dashboard\": \"https://centos 7-ceph-1:8443/\"&#125;#å®‰è£…å®Œæˆ#å¯é€‰#ä¿®æ”¹ipsudo ceph config set mgr mgr/dashboard/server_addr 192.168.153.51#ä¿®æ”¹ç«¯å£sudo ceph config set mgr mgr/dashboard/server_port 8443#ç¦ç”¨httpssudo ceph config set mgr mgr/dashboard/ssl false å®‰è£…é—®é¢˜æ±‡æ€»1.æ ¼å¼åŒ–ç£ç›˜æ—¶æç¤ºå¿™ 1mkfs.xfs: cannot open /dev/sdb: Device or resource busy è§£å†³æ–¹æ³• 123456789lsblk #æ˜¾ç¤ºéƒ¨åˆ†ç£ç›˜æ­£å¸¸ï¼Œéƒ¨åˆ†ä¸‹é¢æœ‰-ceph-**ç­‰æ ‡è¯†ï¼Œç”¨iloå¤šæ¬¡æ ¼å¼åŒ–ç£ç›˜ä½œraid0å‡æ— æ•ˆæœdmsetup ls #æŸ¥çœ‹è°åœ¨å ç”¨ï¼Œæ‰¾åˆ°ceph-**å­—æ ·ï¼ˆceph-**ä¸ºlsblkæ˜¾ç¤ºçš„å—è®¾å¤‡å…·ä½“ä¿¡æ¯ï¼‰#ä½¿ç”¨dmsetup åˆ é™¤å­—æ ·dmsetup remove ceph-**lsblk #æŸ¥çœ‹è®¾å¤‡ä¿¡æ¯ï¼Œå¯ä»¥çœ‹åˆ°ceph-**ç­‰æ ‡è¯†ç­‰æ ‡è¯†æ¶ˆå¤±ceph-deploy disk zap centos7-ceph-3 /dev/sdb #æ ¼å¼åŒ–ç£ç›˜sudo parted -s /dev/sdb mklabel gpt mkpart primary xfs 0% 100%sudo mkfs.xfs /dev/sdb -f 2.ceph-deploy new centos 7-ceph-1 æ—¶ï¼Œæç¤º ImportError: No module named pkg_resources 1234567[cephuser@centos 7-ceph-1 my-cluster]$ ceph-deploy new centos 7-ceph-1Traceback (most recent call last): File \"/bin/ceph-deploy\", line 18, in &lt;module&gt; from ceph_deploy.cli import main File \"/usr/lib/python2.7/site-packages/ceph_deploy/cli.py\", line 1, in &lt;module&gt; import pkg_resourcesImportError: No module named pkg_resources è§£å†³æ–¹æ³• 12345#å®‰è£…pipsudo yum -y install epel-releasesudo yum -y install python-pip#å®‰è£…distributeç±»åº“pip install -i https://pypi.doubanio.com/simple/ --trusted-host pypi.doubanio.com distrbute 3.å¦‚æœå®‰è£…å‡ºé”™å¦‚ä½•æ¸…ç† 12345# å¸è½½Cephå®‰è£…åŒ…ceph-deploy purge &lt;hostname&gt;# æ¸…ç†é…ç½®ceph-deploy purgedata &lt;hostname&gt;ceph-deploy forgetkeys å®‰è£…ceph dashboard æç¤º No module 1Module 'dashboard' has failed dependency: No module named urllib3.exceptions è§£å†³æ–¹æ³• 12#pipå®‰è£… urllib3pip install -i https://pypi.doubanio.com/simple/ --trusted-host pypi.doubanio.com urllib3","categories":[],"tags":[{"name":"Ceph","slug":"Ceph","permalink":"https://zhangjunjunah.github.io/tags/Ceph/"},{"name":"Linux","slug":"Linux","permalink":"https://zhangjunjunah.github.io/tags/Linux/"}]}]}