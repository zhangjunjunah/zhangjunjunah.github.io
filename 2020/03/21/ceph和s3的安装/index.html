<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>ceph和s3的安装 | 机锋小摩托的分享</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="部署说明 安装的ceph版本（14.2.4）、s3 版本(2.0.2)  ceph使用ceph-deploy部署高可用集群至少需要3台节点(ceph 监视器需要3个以上节点)  ceph推荐使用裸盘安装osd(文件夹也可以部署，但不推荐) ceph部署节点规划   节点ip 节点主机名 节点ceph组件    192.168.153.51 centos 7-ceph-1（ceph 主节点） mds">
<meta property="og:type" content="article">
<meta property="og:title" content="ceph和s3的安装">
<meta property="og:url" content="https://zhangjunjunah.github.io/2020/03/21/ceph%E5%92%8Cs3%E7%9A%84%E5%AE%89%E8%A3%85/index.html">
<meta property="og:site_name" content="机锋小摩托的分享">
<meta property="og:description" content="部署说明 安装的ceph版本（14.2.4）、s3 版本(2.0.2)  ceph使用ceph-deploy部署高可用集群至少需要3台节点(ceph 监视器需要3个以上节点)  ceph推荐使用裸盘安装osd(文件夹也可以部署，但不推荐) ceph部署节点规划   节点ip 节点主机名 节点ceph组件    192.168.153.51 centos 7-ceph-1（ceph 主节点） mds">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2020-03-21T07:57:15.000Z">
<meta property="article:modified_time" content="2020-03-21T08:57:30.106Z">
<meta property="article:author" content="Ge Moto">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="机锋小摩托的分享" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">机锋小摩托的分享</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://zhangjunjunah.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-ceph和s3的安装" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/21/ceph%E5%92%8Cs3%E7%9A%84%E5%AE%89%E8%A3%85/" class="article-date">
  <time datetime="2020-03-21T07:57:15.000Z" itemprop="datePublished">2020-03-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      ceph和s3的安装
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="部署说明"><a href="#部署说明" class="headerlink" title="部署说明"></a>部署说明</h4><ul>
<li><p>安装的ceph版本（14.2.4）、s3 版本(2.0.2)</p>
</li>
<li><p>ceph使用ceph-deploy部署高可用集群至少需要3台节点(ceph 监视器需要3个以上节点)</p>
</li>
<li><p>ceph推荐使用裸盘安装osd(文件夹也可以部署，但不推荐)</p>
<h4 id="ceph部署节点规划"><a href="#ceph部署节点规划" class="headerlink" title="ceph部署节点规划"></a>ceph部署节点规划</h4><table>
<thead>
<tr>
<th>节点ip</th>
<th>节点主机名</th>
<th>节点ceph组件</th>
</tr>
</thead>
<tbody><tr>
<td>192.168.153.51</td>
<td>centos 7-ceph-1（ceph 主节点）</td>
<td>mds1、mon1、mg1、rgw、osd1</td>
</tr>
<tr>
<td>192.168.153.52</td>
<td>centos 7-ceph-2</td>
<td>mon2、mg2、osd2、</td>
</tr>
<tr>
<td>192.168.153.53</td>
<td>centos 7-ceph-3</td>
<td>mon3、mg3、osd3</td>
</tr>
</tbody></table>
</li>
</ul>
<h4 id="创建部署用户"><a href="#创建部署用户" class="headerlink" title="创建部署用户"></a>创建部署用户</h4><p>注意，在外网环境，禁止使用 ceph 服务名 作为用户，防止暴力破解。</p>
<p>因为 <code>ceph-deploy</code> 部署工具需要以登录用户（且包含sudo权限）来安装软件和做配置，因此通常在主节点创建 ceph 用户。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 在每一个节点执行（centos 7-ceph-1、centos 7-ceph-2、centos 7-ceph-3）</span></span><br><span class="line">useradd cephuser</span><br><span class="line">echo 'cephuser' | passwd --stdin cephuser</span><br><span class="line">echo "cephuser ALL = (root) NOPASSWD:ALL" &gt; /etc/sudoers.d/cephuser</span><br><span class="line">chmod 0440 /etc/sudoers.d/cephuser</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置sshd可以使用password登录</span></span><br><span class="line">sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config</span><br><span class="line">systemctl reload sshd</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置sudo不需要tty</span></span><br><span class="line">sed -i 's/Default requiretty/#Default requiretty/' /etc/sudoers</span><br><span class="line"><span class="meta">#</span><span class="bash">每个节点添加hosts</span></span><br><span class="line">192.168.153.51 centos 7-ceph-1</span><br><span class="line">192.168.153.52 centos 7-ceph-2</span><br><span class="line">192.168.153.53 centos 7-ceph-3</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置免密登录（使用cephuser用户）</span></span><br><span class="line">ssh-keygen -t rsa </span><br><span class="line"><span class="meta">#</span><span class="bash"> 在centos 7-ceph-1使用cephuser用户操作</span></span><br><span class="line">ssh-copy-id -i /home/cephuser/.ssh/id_rsa.pub cephuser@centos 7-ceph-2</span><br><span class="line">ssh-copy-id -i /home/cephuser/.ssh/id_rsa.pub cephuser@centos 7-ceph-3</span><br></pre></td></tr></table></figure>

<h4 id="创建虚拟卷"><a href="#创建虚拟卷" class="headerlink" title="创建虚拟卷"></a>创建虚拟卷</h4><p>通过虚拟机管理界面分别为每个节点 挂载新磁盘</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 每台节点操作(root)</span></span><br><span class="line">fdisk -l #查看挂载的磁盘名，</span><br><span class="line"><span class="meta">#</span><span class="bash">格式化磁盘</span></span><br><span class="line">parted -s /dev/sdb mklabel gpt mkpart primary xfs 0% 100%</span><br><span class="line">mkfs.xfs /dev/sdb -f</span><br></pre></td></tr></table></figure>

<p><strong>关闭 SetLinux（建议）</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 建议执行，注意需要重启机器</span></span><br><span class="line">setenforce 0  </span><br><span class="line">sed -i  "s/SELINUX=enforcing/SELINUX=disabled /g" /etc/selinux/config  </span><br><span class="line"><span class="meta">#</span><span class="bash"> 重启机器，检查，如果SELinux status参数为disabled即为关闭状态</span></span><br><span class="line">/usr/sbin/sestatus -v</span><br></pre></td></tr></table></figure>

<p><strong>关闭防火墙</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 可选，如果不关闭需要开启对应端口，本例简单的关闭处理</span></span><br><span class="line">systemctl disable firewalld.service  </span><br><span class="line">systemctl stop firewalld.service</span><br></pre></td></tr></table></figure>

<p><strong>配置ntp服务器</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 在三台节点root执行（centos 7-ceph-1、centos 7-ceph-2、centos 7-ceph-3）</span></span><br><span class="line">yum -y install ntp</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将centos 7-ceph-1配置成ntp服务端</span></span><br><span class="line">[root@centos7-ceph-1 ~]# cat /etc/ntp.conf</span><br><span class="line">server 127.127.1.0</span><br><span class="line">fudge 127.127.1.0 stratum 10</span><br><span class="line">restrict 192.168.153.1 mask 255.255.255.0 nomodify notrap</span><br><span class="line"><span class="meta">#</span><span class="bash">启动ntp</span></span><br><span class="line">systemctl start ntpd &amp;&amp; systemctl enable ntpd</span><br><span class="line"><span class="meta">#</span><span class="bash"> centos 7-ceph-2、centos 7-ceph-3配置ntp客户端</span></span><br><span class="line">cat /etc/ntp.conf </span><br><span class="line">server 192.168.153.51</span><br><span class="line"><span class="meta">#</span><span class="bash">执行手动同步</span></span><br><span class="line">ntpdate 192.168.153.51</span><br><span class="line"></span><br><span class="line">systemctl start ntpd &amp;&amp; systemctl enable ntpd</span><br></pre></td></tr></table></figure>

<h4 id="开始部署"><a href="#开始部署" class="headerlink" title="开始部署"></a>开始部署</h4><p><strong>安装 ceph 依赖</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> ceph-deploy 是ceph 的部署工具，在管理节点(centos 7-ceph-1执行)</span></span><br><span class="line">yum install -y ceph-deploy          </span><br><span class="line">ceph-deploy  --version                // 2.0.1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装 ceph 和 radosgw ,在每台节点执行（centos 7-ceph-1、centos 7-ceph-2、centos 7-ceph-3）</span></span><br><span class="line">yum install -y ceph ceph-radosgw</span><br></pre></td></tr></table></figure>

<p><strong>搭建 ceph 服务</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 注意以下所有使用 ceph 用户执行，不要使用 sudo ，不要使用root</span></span><br><span class="line">su - cephuser</span><br><span class="line">mkdir my-cluster</span><br><span class="line">cd my-cluster</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建集群，用 new 命令，并指定几个主机安装初始ceph Monitor 服务</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在centos 7-ceph-1上操作</span></span><br><span class="line">ceph-deploy new centos 7-ceph-1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 此时会在当前目录生成 ceph 配置文件、日志和密钥文件</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 注意实际生效的配置文件将在 /etc/ceph/ceph.conf （当前还未生生成），最佳实践为修改 <span class="variable">$HOME</span> 目录下的文件配置，通过 deploy 工具分发到各节点</span></span><br><span class="line">ls</span><br><span class="line">ceph.conf  ceph-deploy-ceph.log  ceph.mon.keyring</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 需要修改一下配置文件</span></span><br><span class="line">echo "public network = 192.168.153.0/24" &gt;&gt; ceph.conf</span><br><span class="line">echo "cluster network = 192.168.153.0/24" &gt;&gt; ceph.conf</span><br><span class="line">echo "osd pool default size = 3" &gt;&gt; ceph.conf</span><br><span class="line">echo "osd pool default min size = 2" &gt;&gt; ceph.conf</span><br><span class="line">echo "mon_max_pg_per_osd = 650" &gt;&gt; ceph.conf</span><br><span class="line">echo "[osd]" &gt;&gt; ceph.conf</span><br><span class="line">echo "mon_osd_backfillfull_ratio=0.7" &gt;&gt; ceph.conf</span><br><span class="line">echo "mon_osd_full_ratio=0.8" &gt;&gt; ceph.conf</span><br><span class="line">echo "mon_osd_nearfull_ratio=0.6" &gt;&gt; ceph.conf</span><br><span class="line">echo "osd_failsafe_full_ratio=0.8" &gt;&gt; ceph.conf</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 部署monitor和生成keys</span></span><br><span class="line">ceph-deploy mon create-initial</span><br><span class="line">ls -l *.keyring</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 复制文件到node节点</span></span><br><span class="line">ceph-deploy  --overwrite-conf  admin centos 7-ceph-1 centos 7-ceph-2 centos 7-ceph-3</span><br><span class="line"><span class="meta">#</span><span class="bash"> 部署manager （luminous+）12及以后的版本需要部署</span></span><br><span class="line">ceph-deploy mgr create centos 7-ceph-1</span><br></pre></td></tr></table></figure>

<p><strong>创建 OSD（对象存储后台进程）</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">在centos 7-ceph-1用cephuser用户执行</span></span><br><span class="line">ceph-deploy osd create --data /dev/sdb centos 7-ceph-1  </span><br><span class="line">ceph-deploy osd create --data /dev/sdb centos 7-ceph-2  </span><br><span class="line">ceph-deploy osd create --data  /dev/sdb centos 7-ceph-3 </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看 osd tree和ceph集群状态</span></span><br><span class="line">sudo ceph osd tree</span><br><span class="line">sudo ceph -s</span><br><span class="line">sudo ceph health detail        //HEALTH_OK</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 至此 基本ceph安装完毕</span></span><br></pre></td></tr></table></figure>

<p><strong>高可用配置(mon、mgr)</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 添加monitor</span></span><br><span class="line">ceph-deploy mon add centos 7-ceph-2</span><br><span class="line">ceph-deploy mon add centos 7-ceph-3</span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加manager</span></span><br><span class="line">ceph-deploy mgr create  centos 7-ceph-2 centos 7-ceph-3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 卸载monitor</span></span><br><span class="line">ceph-deploy mon destroy centos 7-ceph-2</span><br></pre></td></tr></table></figure>



<h4 id="部署RGW"><a href="#部署RGW" class="headerlink" title="部署RGW"></a>部署RGW</h4><p>Ceph部署RGW以兼容S3/Swift接口，即可以使用S3或Swift的命令行工具或SDK来使用ceph。</p>
<p><strong>部署RGW网关</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 启动 RGW，注意开放的网关端口，默认7480</span></span><br><span class="line">ceph-deploy rgw create  centos 7-ceph-1  // The Ceph Object Gateway (RGW) is now running on host centos 7-ceph-1 and default port 7480</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 访问测试</span></span><br><span class="line">curl -I http://centos 7-ceph-1:7480/</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">x-amz-request-id: tx000000000000000000001-005d0b0e2a-1018-default</span><br><span class="line">Content-Type: application/xml</span><br><span class="line">Content-Length: 0</span><br><span class="line">Date: Thu, 20 Jun 2019 04:40:11 GMT</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 页面访问测试 </span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash"> 至此 Ceph 端对象访问接口已经部署完成，可使用s3 工具访问 </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 附其他操作 </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 附1：更改开放端口，需重启RGW</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改配置 /etc/ceph/ceph.conf，使用 rgw 监听在 80 端口</span></span><br><span class="line"></span><br><span class="line"> [client.rgw.lab1]</span><br><span class="line">rgw_frontends = "civetweb port=80"</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash"> 附2：重启 RGW</span></span><br><span class="line">systemctl restart ceph-radosgw@rgw.k8s113</span><br></pre></td></tr></table></figure>

<h4 id="对象存储服务与测试（S3-Swift）"><a href="#对象存储服务与测试（S3-Swift）" class="headerlink" title="对象存储服务与测试（S3/Swift）"></a>对象存储服务与测试（S3/Swift）</h4><p><strong>离线安装 s3cmd</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">rpm -ivh python-dateutil-1.5-7.el7.noarch.rpm python-magic-5.11-35.el7.noarch.rpm s3cmd-2.0.2-1.el7.noarch.rpm</span><br><span class="line"></span><br><span class="line">s3cmd --version</span><br><span class="line">s3cmd version 2.0.2</span><br></pre></td></tr></table></figure>

<p><strong>对象存储测试（使用s3cmd测试）</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 测试</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建S3所需要的pool</span></span><br><span class="line">sudo ceph osd pool create .rgw 128 128</span><br><span class="line">sudo ceph osd pool create .rgw.root 128 128</span><br><span class="line">sudo ceph osd pool create .rgw.control 128 128</span><br><span class="line">sudo ceph osd pool create .rgw.gc 128 128</span><br><span class="line">sudo ceph osd pool create .rgw.buckets 128 128</span><br><span class="line">sudo ceph osd pool create .rgw.buckets.index 128 128</span><br><span class="line">sudo ceph osd pool create .rgw.buckets.extra 128 128</span><br><span class="line">sudo ceph osd pool create .log 128 128</span><br><span class="line">sudo ceph osd pool create .intent-log 128 128</span><br><span class="line">sudo ceph osd pool create .usage 128 128</span><br><span class="line">sudo ceph osd pool create .users 128 128</span><br><span class="line">sudo ceph osd pool create .users.email 128 128</span><br><span class="line">sudo ceph osd pool create .users.swift 128 128</span><br><span class="line">sudo ceph osd pool create .users.uid 128 128</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看</span></span><br><span class="line">rados lspools</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 访问测试</span></span><br><span class="line">curl -I http://192.168.153.51:7480/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建S3用户</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 注意：保存命令返回的 user access_key secret_key</span></span><br><span class="line">sudo radosgw-admin user create --uid=s3_user --display-name=s3_user --email=s3@s3.com</span><br><span class="line"></span><br><span class="line">"access_key": "FZ95GV7T0WU8OVOL4YH9",</span><br><span class="line">"secret_key": "WFgeHmpjywZ3AAWDjc3atNOsGAP7gJkNmUVWHoPK"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建admin用户</span></span><br><span class="line">radosgw-admin user create --uid=admin --display-name=admin</span><br><span class="line"></span><br><span class="line">"access_key": "B3M00AHVE9FEXCQ8D0L9",</span><br><span class="line">"secret_key": "JVJG1O4LDGam35EBghXGsgrdOwhqGzVKPtR6ntw4"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 允许admin读写所有users信息</span></span><br><span class="line">radosgw-admin caps add --uid=admin --caps="users=*"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 允许admin读写所有的usage信息</span></span><br><span class="line">radosgw-admin caps add --uid=admin --caps="usage=read,write"</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置s3cmd（当前在 ceph目录下，附完整过程，输入之前创建的 s3_user_tydic 用户密钥） </span></span><br><span class="line">s3cmd --configure</span><br><span class="line">Enter new values or accept defaults in brackets with Enter.</span><br><span class="line">Refer to user manual for detailed description of all options.</span><br><span class="line"></span><br><span class="line">Access key and Secret key are your identifiers for Amazon S3. Leave them empty for using the env variables.</span><br><span class="line">Access Key: FZ95GV7T0WU8OVOL4YH9</span><br><span class="line">Secret Key: WFgeHmpjywZ3AAWDjc3atNOsGAP7gJkNmUVWHoPK</span><br><span class="line">Default Region [US]:</span><br><span class="line"></span><br><span class="line">Use "s3.amazonaws.com" for S3 Endpoint and not modify it to the target Amazon S3.</span><br><span class="line">S3 Endpoint [s3.amazonaws.com]: 192.168.153.51:7480     //注意：此处必须使用 ip:port 形式，使用域名方式将会导致从s3cmd创建的桶必须是以大写字母开头，此命名与亚马逊官方桶命名要求相悖，建议修改为ip:port 方式。</span><br><span class="line"></span><br><span class="line">Use "%(bucket)s.s3.amazonaws.com" to the target Amazon S3. "%(bucket)s" and "%(location)s" vars can be used</span><br><span class="line">if the target S3 system supports dns based buckets.</span><br><span class="line">DNS-style bucket+hostname:port template for accessing a bucket [%(bucket)s.s3.amazonaws.com]: 192.168.153.51:7480   //ip:port 形式</span><br><span class="line"></span><br><span class="line">Encryption password is used to protect your files from reading</span><br><span class="line">by unauthorized persons while in transfer to S3</span><br><span class="line">Encryption password:    //空</span><br><span class="line">Path to GPG program [/bin/gpg]:  //空</span><br><span class="line"></span><br><span class="line">When using secure HTTPS protocol all communication with Amazon S3</span><br><span class="line">servers is protected from 3rd party eavesdropping. This method is</span><br><span class="line">slower than plain HTTP, and can only be proxied with Python 2.7 or newer</span><br><span class="line">Use HTTPS protocol [Yes]: no</span><br><span class="line"></span><br><span class="line">On some networks all internet access must go through a HTTP proxy.</span><br><span class="line">Try setting it here if you can't connect to S3 directly</span><br><span class="line">HTTP Proxy server name: //空</span><br><span class="line"></span><br><span class="line">Test access with supplied credentials? [Y/n] y</span><br><span class="line">Please wait, attempting to list all buckets...</span><br><span class="line">Success. Your access key and secret key worked fine :-)</span><br><span class="line"></span><br><span class="line">Now verifying that encryption works...</span><br><span class="line">Not configured. Never mind.</span><br><span class="line"></span><br><span class="line">Save settings? [y/N] y</span><br><span class="line">Configuration saved to '/home/ceph/.s3cfg'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 注意 s3 配置文件生成位置修该生成的配置文件，后续可做自定义修改</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 重点配置项示例，其他项均为默认项</span></span><br><span class="line">[default]</span><br><span class="line">access_key = FZ95GV7T0WU8OVOL4YH9</span><br><span class="line">secret_key = WFgeHmpjywZ3AAWDjc3atNOsGAP7gJkNmUVWHoPK</span><br><span class="line">host_base = 192.168.153.51:7480</span><br><span class="line">host_bucket = 192.168.153.51:7480</span><br><span class="line">use_https = False</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建Bucket（注意命令行端bucket首字母必须大写）</span></span><br><span class="line">s3cmd mb s3://MyBucket_1</span><br><span class="line">s3cmd ls</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 上传Object</span></span><br><span class="line">echo 'hello ceph block storage s3' &gt; hello.txt</span><br><span class="line">s3cmd put hello.txt s3://MyBucket_1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看Object</span></span><br><span class="line">s3cmd ls s3://MyBucket_1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 下载Object</span></span><br><span class="line">cd /tmp</span><br><span class="line">s3cmd get s3://mybucket/hello.txt</span><br><span class="line">cat hello.txt</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除bucket下所有对象</span></span><br><span class="line">s3cmd del -rf s3://MyBucket_1 </span><br><span class="line">s3cmd ls -r s3://MyBucket_1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除Bucket</span></span><br><span class="line">s3cmd mb s3://MyBucket_1</span><br><span class="line">s3cmd rb s3://MyBucket_1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 其他操作</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除S3用户</span></span><br><span class="line">radosgw-admin user rm --uid=s3_user_tydic</span><br><span class="line">radosgw-admin user rm --uid=admin</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">调整pool副本数</span></span><br><span class="line">ceph osd pool set default.rgw.buckets.data size 3</span><br><span class="line">ceph osd pool set default.rgw.buckets.data min_size 2</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除pool</span></span><br><span class="line">ceph osd pool delete .rgw .rgw --yes-i-really-really-mean-it</span><br><span class="line">ceph osd pool delete .rgw.root .rgw.root --yes-i-really-really-mean-it</span><br><span class="line">ceph osd pool delete .rgw.control .rgw.control --yes-i-really-really-mean-it</span><br><span class="line">ceph osd pool delete .rgw.gc .rgw.gc --yes-i-really-really-mean-it</span><br><span class="line">ceph osd pool delete .rgw.buckets .rgw.buckets --yes-i-really-really-mean-it</span><br><span class="line">ceph osd pool delete .rgw.buckets.index .rgw.buckets.index --yes-i-really-really-mean-it</span><br><span class="line">ceph osd pool delete .rgw.buckets.extra .rgw.buckets.extra --yes-i-really-really-mean-it</span><br><span class="line">ceph osd pool delete .log .log --yes-i-really-really-mean-it</span><br><span class="line">ceph osd pool delete .intent-log .intent-log --yes-i-really-really-mean-it</span><br><span class="line">ceph osd pool delete .usage .usage --yes-i-really-really-mean-it</span><br><span class="line">ceph osd pool delete .users .users --yes-i-really-really-mean-it</span><br><span class="line">ceph osd pool delete .users.email .users.email --yes-i-really-really-mean-it</span><br><span class="line">ceph osd pool delete .users.swift .users.swift --yes-i-really-really-mean-it</span><br><span class="line">ceph osd pool delete .users.uid .users.uid --yes-i-really-really-mean-it</span><br></pre></td></tr></table></figure>

<h4 id="Ceph-Dashboard"><a href="#Ceph-Dashboard" class="headerlink" title="Ceph Dashboard"></a>Ceph Dashboard</h4><h5 id="Ceph-Dashboard介绍"><a href="#Ceph-Dashboard介绍" class="headerlink" title="Ceph Dashboard介绍"></a>Ceph Dashboard介绍</h5><p>Ceph 的监控可视化界面方案很多—-grafana、Kraken。但是从Luminous开始，Ceph 提供了原生的Dashboard功能，通过Dashboard可以获取Ceph集群的各种基本状态信息。</p>
<h5 id="配置Ceph-Dashboard"><a href="#配置Ceph-Dashboard" class="headerlink" title="配置Ceph Dashboard"></a>配置Ceph Dashboard</h5><h6 id="安装和配置"><a href="#安装和配置" class="headerlink" title="安装和配置"></a>安装和配置</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1、在每个mgr节点安装 </span></span><br><span class="line">yum install ceph-mgr-dashboard  </span><br><span class="line"><span class="meta">#</span><span class="bash"> 2、开启mgr功能 </span></span><br><span class="line">ceph mgr module enable dashboard </span><br><span class="line"><span class="meta">#</span><span class="bash"> 3、生成并安装自签名的证书 </span></span><br><span class="line">ceph dashboard create-self-signed-cert   </span><br><span class="line"><span class="meta">#</span><span class="bash"> 4、创建一个dashboard登录用户名密码 </span></span><br><span class="line">ceph dashboard ac-user-create super 123456 administrator  </span><br><span class="line"><span class="meta">#</span><span class="bash"> 5、查看服务访问方式 </span></span><br><span class="line">ceph mgr services</span><br><span class="line">&#123;</span><br><span class="line">    "dashboard": "https://centos 7-ceph-1:8443/"</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash">安装完成</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">可选</span></span><br><span class="line"><span class="meta">#</span><span class="bash">修改ip</span></span><br><span class="line">sudo ceph config set mgr mgr/dashboard/server_addr 192.168.153.51</span><br><span class="line"><span class="meta">#</span><span class="bash">修改端口</span></span><br><span class="line">sudo ceph config set mgr mgr/dashboard/server_port 8443</span><br><span class="line"><span class="meta">#</span><span class="bash">禁用https</span></span><br><span class="line">sudo ceph config set mgr mgr/dashboard/ssl false</span><br></pre></td></tr></table></figure>



<h4 id="安装问题汇总"><a href="#安装问题汇总" class="headerlink" title="安装问题汇总"></a>安装问题汇总</h4><p>1.格式化磁盘时提示忙</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkfs.xfs: cannot open /dev/sdb: Device or resource busy</span><br></pre></td></tr></table></figure>
<p><strong>解决方法</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">lsblk  #显示部分磁盘正常，部分下面有-ceph-**等标识，用ilo多次格式化磁盘作raid0均无效果</span><br><span class="line">dmsetup ls #查看谁在占用，找到ceph-**字样（ceph-**为lsblk显示的块设备具体信息）</span><br><span class="line"><span class="meta">#</span><span class="bash">使用dmsetup 删除字样</span></span><br><span class="line">dmsetup remove ceph-**</span><br><span class="line">lsblk #查看设备信息，可以看到ceph-**等标识等标识消失</span><br><span class="line">ceph-deploy disk zap centos7-ceph-3  /dev/sdb </span><br><span class="line"><span class="meta">#</span><span class="bash">格式化磁盘</span></span><br><span class="line">sudo parted -s /dev/sdb mklabel gpt mkpart primary xfs 0% 100%</span><br><span class="line">sudo mkfs.xfs /dev/sdb -f</span><br></pre></td></tr></table></figure>

<p>2.ceph-deploy new  centos 7-ceph-1 时，提示 ImportError: No module named pkg_resources</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[cephuser@centos 7-ceph-1 my-cluster]$ ceph-deploy new  centos 7-ceph-1</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File "/bin/ceph-deploy", line 18, in &lt;module&gt;</span><br><span class="line">    from ceph_deploy.cli import main</span><br><span class="line">  File "/usr/lib/python2.7/site-packages/ceph_deploy/cli.py", line 1, in &lt;module&gt;</span><br><span class="line">    import pkg_resources</span><br><span class="line">ImportError: No module named pkg_resources</span><br></pre></td></tr></table></figure>

<p><strong>解决方法</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">安装pip</span></span><br><span class="line">sudo yum -y install epel-release</span><br><span class="line">sudo yum -y install python-pip</span><br><span class="line"><span class="meta">#</span><span class="bash">安装distribute类库</span></span><br><span class="line">pip install  -i  https://pypi.doubanio.com/simple/  --trusted-host pypi.doubanio.com distrbute</span><br></pre></td></tr></table></figure>

<p>3.如果安装出错如何清理</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 卸载Ceph安装包</span></span><br><span class="line">ceph-deploy purge &lt;hostname&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 清理配置</span></span><br><span class="line">ceph-deploy purgedata  &lt;hostname&gt;</span><br><span class="line">ceph-deploy forgetkeys</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>安装ceph dashboard 提示 No module</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Module 'dashboard' has failed dependency: No module named urllib3.exceptions</span><br></pre></td></tr></table></figure>
<p><strong>解决方法</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">pip安装 urllib3</span></span><br><span class="line">pip install -i  https://pypi.doubanio.com/simple/  --trusted-host pypi.doubanio.com urllib3</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://zhangjunjunah.github.io/2020/03/21/ceph%E5%92%8Cs3%E7%9A%84%E5%AE%89%E8%A3%85/" data-id="ck81bnd2o0000xsuig6rr5abh" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/03/21/ceph%E5%92%8Cs3%E7%9A%84%E5%AE%89%E8%A3%85/">ceph和s3的安装</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 Ge Moto<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>